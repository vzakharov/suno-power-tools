window.templates = {"tree":"<head>\n  <style>\n    body { \n      margin: 0;\n      font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, \"Helvetica Neue\", Arial, sans-serif;\n    }\n\n    #sidebar {\n      position: fixed;\n      padding: 10px;\n      top: 0;\n      left: 0;\n      bottom: 0;\n      width: 200px;\n      background-color: #333;\n      color: #eee;\n      display: flex;\n      flex-direction: column;\n      justify-content: space-between;\n    }\n\n    .f-row {\n      display: flex;\n      flex-direction: row;\n    }\n\n    .f-col {\n      display: flex;\n      flex-direction: column;\n    }\n\n    .smol {\n      font-size: 0.8em;\n      color: #aaa;\n    }\n\n    .relative {\n      position: relative;\n    }\n\n    .absolute {\n      position: absolute;\n    }\n\n    .topleft {\n      top: 0;\n      left: 0;\n    }\n\n    .p-1 {\n      padding: 1rem;\n    };\n\n    .p-2 {\n      padding: 2rem;\n    }\n\n    .w-100 {\n      width: 100%;\n    }\n    \n    .h-100 {\n      height: 100%;\n    }\n\n    .j-between {\n      justify-content: space-between;\n    }\n\n  </style>\n  <script src=\"//unpkg.com/force-graph\"></script>\n  <script src=\"//unpkg.com/3d-force-graph\"></script>\n</head>\n\n<body>\n  <div id=\"graph\">\n  </div>\n  <div id=\"sidebar\">\n    <div>\n      <h3>Settings</h3>\n      <div>\n        <input type=\"checkbox\" id=\"use3DGraph\">\n        <label for=\"use3DGraph\">3D graph</label>\n      </div>\n      <div>\n        <input type=\"checkbox\" id=\"useNextLinks\" data-type=\"linkToggle\" data-kind=\"next\" checked>\n        <label for=\"useNextLinks\">Attract based on time</label>\n      </div>\n      <div id=\"showNextLinksContainer\">\n        <input type=\"checkbox\" id=\"showNextLinks\" data-type=\"linkToggle\" data-kind=\"descendant\">\n        <label for=\"showNextLinks\">Show time-based links</label>\n      </div>\n      <div>\n        <input type=\"checkbox\" id=\"useDescendantLinks\" data-type=\"linkToggle\" data-kind=\"descendant\" checked>\n        <label for=\"useDescendantLinks\">Attract to root clip</label>\n      </div>\n    </div>\n    <div id=\"audioContainer\" class=\"w-100\" style=\"display: none;\">\n      <div class=\"relative\">\n        <a id=\"audioLink\" target=\"_blank\">\n          <img id=\"audioImage\" style=\"opacity: 0.5\" class=\"w-100\">\n        </a>\n        <div class=\"absolute topleft\" style=\"width: 190px; padding: 5px;\">\n          <div id=\"audioName\"></div>\n          <div class=\"smol\" id=\"audioTags\"></div>\n        </div>\n      </div>\n      <audio controls id=\"audio\" class=\"w-100\"></audio>\n    </div>\n  </div>    \n  <div id=\"data\" style=\"display: none;\">\n    __data__\n  </div>\n  <script>\n\n\n    const data = JSON.parse(document.getElementById('data').innerText);\n    let graph = renderGraph(data, false);\n\n    function visibilityChecker(link) {\n      return !{\n        descendant: true,\n        next: !document.getElementById('showNextLinks').checked\n      }[link.kind];\n    };\n\n    function renderGraph(data, use3DGraph) {\n      const Renderer = use3DGraph ? ForceGraph3D : ForceGraph;\n      const graph = new Renderer()\n        (document.getElementById('graph'))\n        .graphData(data)\n        .backgroundColor('#001')\n        .linkAutoColorBy('kind')\n        .nodeAutoColorBy('rootId')\n        .linkLabel('kind')\n        .linkVisibility(visibilityChecker)\n        .linkDirectionalParticles(1)\n        .nodeLabel(({ id, name, tags, image_url }) => `\n          <div class=\"relative\" style=\"width: 200px;\">\n            <img src=\"${image_url}\" style=\"opacity: 0.5; width: 200px\">\n            <div class=\"absolute topleft p-1 w-100\">\n              <div>${name || '[Untitled]'}</div>\n              <div class=\"smol\">${tags || '(no style)'}</div>\n            </div>\n          </div>\n          <div class=\"smol\">\n            Click to play, right-click to open in new tab\n          </div>\n        `)\n        .onNodeClick(({ id, name, tags, image_url, audio_url }) => {\n          document.getElementById('audioContainer').style.display = 'block';\n          document.getElementById('audioLink').href = `https://suno.com/song/${id}`;\n          document.getElementById('audioImage').src = image_url;\n          document.getElementById('audioName').innerText = name || '[Untitled]';\n          document.getElementById('audioTags').innerText = tags || '(no style)';\n          const audio = document.getElementById('audio');\n          audio.src = audio_url;\n          audio.play();\n        })\n        .onNodeRightClick(({ id }) => {\n          window.open(`https://suno.com/song/${id}`);\n        });\n      if ( use3DGraph ) {\n        graph.linkOpacity(l => l.isMain ? 1 : 0.2)\n      } else {\n        graph.linkLineDash(l => l.isMain ? undefined : [1, 2])\n      }\n      return graph;\n    };\n\n    const use3DGraphCheckbox = document.getElementById('use3DGraph');\n    use3DGraphCheckbox.addEventListener('change', () => {\n      graph = renderGraph(graph.graphData(), use3DGraphCheckbox.checked);\n    });\n\n    document.querySelectorAll('[data-type=\"linkToggle\"]').forEach(checkbox => {\n      checkbox.addEventListener('change', () => {\n        const kind = checkbox.getAttribute('data-kind');\n        const useLinks = checkbox.checked;\n        let { nodes, links } = graph.graphData();\n        if ( !useLinks ) {\n          links = links.filter(l => l.kind !== kind);\n        } else {\n          links.push(...data.links.filter(l => l.kind === kind));\n        }\n        graph.graphData({ nodes, links });\n        if ( kind === 'next' ) {\n          document.getElementById('showNextLinksContainer').style.display = useLinks ? 'block' : 'none';\n        };\n      });\n    });\n\n    document.getElementById('showNextLinks').addEventListener('change', () => {\n      graph.linkVisibility(visibilityChecker);\n    });\n\n  </script>\n</body>"};
(()=>{function C(){return[]}function D(i,t){return t(i)}function $(i){return JSON.parse(JSON.stringify(i))}function S(i,t){Object.assign(i,t)}var _=0;function y(i){let t=Math.max(0,i-(Date.now()-_));return new Promise(e=>{setTimeout(()=>{_=Date.now(),e()},t)})}function l(i){throw new Error(i)}async function R(){let i=document.createElement("input");return i.type="file",i.click(),new Promise(t=>{i.onchange=()=>{let e=i.files?.[0];if(!e)return t(void 0);let n=new FileReader;n.onload=()=>{t(n.result),i.remove()},n.readAsText(e)}})}function P(i){return i?new Date(i).getTime():0}function k(i,t=e=>e.created_at){return i.sort((e,n)=>P(t(e))-P(t(n)))}async function U(i,t){for(let e of t.slice(t.findIndex(n=>n.id===i.id)+1))if(e!==i&&e.metadata.tags===i.metadata.tags&&await M(e.image_url,i.image_url))return console.warn(`Found potential base clip for cropped clip ${i.id}: ${e.id} (this is not guaranteed to be correct)`),e.id;console.warn(`Could not find a base clip for cropped clip ${i.id}, the clip will be mistakenly marked as a root clip.`)}async function B(i){let e=await(await fetch(i)).blob();return new Promise((n,s)=>{let o=new Image;o.onload=()=>{URL.revokeObjectURL(o.src),n(o)},o.onerror=s,o.src=URL.createObjectURL(e)})}async function M(i,t){let e=await B(i),n=await B(t),s=document.createElement("canvas");s.width=e.width,s.height=e.height;let o=s.getContext("2d")??l("Canvas 2D context not supported");o.drawImage(e,0,0);let r=o.getImageData(0,0,e.width,e.height);o.drawImage(n,0,0);let c=o.getImageData(0,0,n.width,n.height),a=r.data,T=c.data,p=a.length,d=0;for(let u=0;u<p;u+=4)for(let g=0;g<3;g++)d+=Math.abs(a[u+g]-T[u+g]);let E=d/(p/4);return s.remove(),E<32;}function f(i,t){return i.find(O(t))}function O(i){return function(t){return Object.entries(i).every(([e,n])=>t[e]===n)}}function x(){return window.suno??l("`suno` object not found in `window`. Have you followed the setup instructions?")}var m=class{resolve;reject;promise;constructor(){this.promise=new Promise((t,e)=>Object.assign(this,{resolve:t,reject:e}))}};var A="vovas",w="sunoTools",F=new Promise((i,t)=>{let e=indexedDB.open(A,1);e.onupgradeneeded=()=>e.result.createObjectStore(w),e.onsuccess=()=>i(e.result),e.onerror=()=>t(e.error)});async function j(i){return(await F).transaction(w,i)}async function K(i){return(await j(i)).objectStore(w)}var h=class{constructor(t,e){this.key=t;this.init=e}async load(){let t=(await K("readonly")).get(this.key);return new Promise((e,n)=>{t.onsuccess=()=>e(t.result??this.init),t.onerror=()=>n(t.error)})}async save(t){let e=await j("readwrite");return e.objectStore(w).put(t,this.key),new Promise((n,s)=>{e.oncomplete=()=>n(),e.onerror=()=>s(e.error)})}};function I(i,t){return Object.keys(t).reduce((e,n)=>e.replace(`__${n}__`,t[n]),i)}var b={rawClips:C(),lastProcessedPage:-1,allPagesProcessed:!1,links:C(),allLinksBuilt:!1},L=class{constructor(t=b){this.state=t;this.loadState()}reset(){this.state=b,console.log("Tree reset. Run build() to start building it again.")}storage=new h("tree",b);stateLoaded=new m;async loadState(t=!1){if(t){let e=await R();if(!e){console.log("No file selected, aborting.");return}this.state=JSON.parse(e)}else this.state=await this.storage.load();this.stateLoaded.resolve()}async saveState(t=!1){if(t){let e=JSON.stringify(this.state),n=new Blob([e],{type:"application/json"}),s=URL.createObjectURL(n),o=document.createElement("a");o.href=s,o.download="suno_tree.json",o.click(),URL.revokeObjectURL(s)}else await this.storage.save(this.state)}async build(){this.state.allPagesProcessed||await this.fetchClips(),this.state.allLinksBuilt||await this.buildLinks()}async fetchClips(){for(console.log("Fetching liked clips...");;){await y(1e3);let{data:{clips:t}}=await x().root.apiClient.GET("/api/feed/v2",{params:{query:{is_liked:!0,page:this.state.lastProcessedPage+1}}});if(!t.length){this.state.allPagesProcessed=!0;break}this.state.rawClips.push(...t),this.state.lastProcessedPage++,console.log(`Processed page ${this.state.lastProcessedPage}; total clips: ${this.state.rawClips.length}`)}}rawClipsById={};async loadClip(t){await y(1e3);console.log(`Clip ${t} not found in cache, loading...`);let e=await x().root.clips.loadClipById(t)??q(t);return this.state.rawClips.push(e),e}getClipByIdSync(t){t.startsWith("m_")&&(t=t.slice(2));return this.rawClipsById[t]??=this.state.rawClips.find(e=>N(t)?e.audio_url.includes(t):e.id===t)}async getClipById(t){return this.getClipByIdSync(t)??await this.loadClip(t)}async buildLinks(){console.log("Building links...");for(let t=0;t<this.state.rawClips.length;t++){let e=this.state.rawClips[t];t%100===0&&console.log(`Processed ${t} clips out of ${this.state.rawClips.length}`);let{metadata:n}=e,[s,o]="history"in n?D(n.history[0],r=>typeof r=="string"?[r,"extend"]:r.infill?[r.id,"inpaint"]:[r.id,"extend"]):"concat_history"in n?[n.concat_history[1].id,"apply"]:"cover_clip_id"in n?[n.cover_clip_id,"cover"]:"upsample_clip_id"in n?[n.upsample_clip_id,"remaster"]:"type"in n&&n.type==="edit_crop"?await U(e,this.state.rawClips).then(r=>r?[r,"crop"]:[void 0,void 0]):[void 0,void 0];s&&this.state.links.push([(await this.getClipById(s)).id,e.id,o])}this.state.allLinksBuilt=!0,console.log(`Built ${this.state.links.length} links.`)}_linkedClips;get linkedClips(){return this._linkedClips??=this.getLinkedClips()}getLinkedClips(){let t=this.state.links.reduce((n,[s,o,r])=>{let c=f(n,{id:s})??l(`Could not find parent for link ${s} -> ${o}.`),a=f(n,{id:o})??l(`Could not find child for link ${s} -> ${o}.`);if(a.parent)throw new Error(`Child ${o} already has a parent: ${a.parent.clip.id}`);return a.parent={kind:r,clip:c},(c.children??=[]).push({kind:r,clip:a}),n},$(this.state.rawClips));for(let n of t.filter(({parent:s})=>!s))e(n,n);return t;function e(n,s){Object.assign(n,{root:s});for(let{clip:o}of n.children??[])e(o,s)}}_rootClips;get rootClips(){return this._rootClips??=this.getRootClips()}getRootClips(){let t=this.linkedClips.filter(({parent:e})=>!e);return k(t)}get sortedClips(){let t=[],{rootClips:e}=this;for(let s of e)n(s);return t.reverse();function n(s){t.push(s);let{children:o}=s;if(o)for(let{clip:r}of k(o,({clip:c})=>c.created_at))n(r)}}get rootLinks(){let t=[],{rootClips:e}=this,n=e[0];for(let s of e.slice(1))t.push([n.id,s.id,"next"]),s?.children?.length&&(n=s);for(let s of this.linkedClips.filter(({children:o})=>o?.length))t.push([(s.root??l(`Clip ${s.id} has no root.`)).id,s.id,"descendant"]);return t}getTotalDescendants(t){let e=f(this.linkedClips,{id:t})??l(`Clip ${t} not found.`);return e.totalDescendants??=1+(e.children?.reduce((n,{clip:{id:s}})=>n+this.getTotalDescendants(s),0)??0)}get graphData(){let t=([s,o,r])=>({source:s,target:o,kind:r,color:r==="next"?"#006":void 0}),e=this.state.links.map(t).map(s=>({...s,isMain:this.getTotalDescendants(s.target)>1}));return{nodes:this.sortedClips.map(({id:s,title:o,metadata:{tags:r},created_at:c,children:a,audio_url:T,image_url:p,root:d})=>({id:s,name:o||r||c||s,audio_url:T,image_url:p,tags:r,rootId:d?.id,val:s===d?.id&&a?.length?2:a?.length?1:.5})),links:[...this.rootLinks.map(t),...e]}}get html(){return I(window.templates.tree,{data:JSON.stringify(this.graphData)})}openHtml(){let t=window.open();if(!t){console.error("Failed to open new window.");return}t.document.write(this.html)}},v=new L;v.stateLoaded.promise.then(()=>{console.log("Tree state loaded");let{state:{allPagesProcessed:i,allLinksBuilt:t}}=v;console.log(!i||!t?"Tree state is incomplete. Run `await vovas.tree.build()` to complete it.":"Tree state is complete, you can now run `await vovas.tree.openHtml()` to view the tree.")});function N(i){return i.match(/_\d+$/)}function q(i){return console.warn(`Clip ${i} not found, creating a missing clip.`),{isMissing:!0,id:i,title:"*Clip not found*",created_at:null,audio_url:`https://cdn1.suno.ai/${i}.mp3`,image_url:"",metadata:{duration:0,tags:""}}}S(window,{vovas:{tree:v}});})();
