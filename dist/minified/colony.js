window.templates = {"colony":"<head>\n  <style>\n    body { \n      margin: 0;\n      font-family: -apple-system, BlinkMacSystemFont, \"Segoe UI\", Roboto, \"Helvetica Neue\", Arial, sans-serif;\n    }\n\n    #sidebar {\n      position: fixed;\n      padding: 10px;\n      top: 0;\n      left: 0;\n      bottom: 0;\n      width: 200px;\n      background-color: #333;\n      color: #eee;\n      display: flex;\n      flex-direction: column;\n      justify-content: space-between;\n    }\n\n    .f-row {\n      display: flex;\n      flex-direction: row;\n    }\n\n    .f-col {\n      display: flex;\n      flex-direction: column;\n    }\n\n    .smol {\n      font-size: 0.8em;\n      color: #aaa;\n    }\n\n    .relative {\n      position: relative;\n    }\n\n    .absolute {\n      position: absolute;\n    }\n\n    .topleft {\n      top: 0;\n      left: 0;\n    }\n\n    .p-1 {\n      padding: 1rem;\n    };\n\n    .p-2 {\n      padding: 2rem;\n    }\n\n    .w-100 {\n      width: 100%;\n    }\n    \n    .h-100 {\n      height: 100%;\n    }\n\n    .j-between {\n      justify-content: space-between;\n    }\n\n  </style>\n  <script src=\"//unpkg.com/___graph_url_slug___\"></script>\n</head>\n\n<body>\n  <div id=\"graph\">\n  </div>\n  <div id=\"sidebar\">\n    <div>\n      <h3>Settings</h3>\n      <div>\n        <input type=\"checkbox\" id=\"useNextLinks\" data-type=\"linkToggle\" data-kind=\"next\" checked>\n        <label for=\"useNextLinks\">Attract based on time</label>\n      </div>\n      <div id=\"showNextLinksContainer\">\n        <input type=\"checkbox\" id=\"showNextLinks\" data-type=\"linkToggle\" data-kind=\"descendant\">\n        <label for=\"showNextLinks\">Show time-based links</label>\n      </div>\n      <div>\n        <input type=\"checkbox\" id=\"useDescendantLinks\" data-type=\"linkToggle\" data-kind=\"descendant\" checked>\n        <label for=\"useDescendantLinks\">Attract to root clip</label>\n      </div>\n    </div>\n    <div id=\"audioContainer\" class=\"w-100\" style=\"display: none;\">\n      <div class=\"relative\">\n        <a id=\"audioLink\" target=\"_blank\">\n          <img id=\"audioImage\" style=\"opacity: 0.5\" class=\"w-100\">\n        </a>\n        <div class=\"absolute topleft\" style=\"width: 190px; padding: 5px;\">\n          <div id=\"audioName\"></div>\n          <div class=\"smol\" id=\"audioTags\"></div>\n        </div>\n      </div>\n      <audio controls id=\"audio\" class=\"w-100\"></audio>\n    </div>\n  </div>    \n  <div id=\"data\" style=\"display: none;\">\n    ___data___\n  </div>\n  <script>\n\n    const use3DGraph = ___use3DGraph___;\n    const data = JSON.parse(document.getElementById('data').innerText);\n    let graph = renderGraph(data);\n\n    function visibilityChecker(link) {\n      return !{\n        descendant: true,\n        next: !document.getElementById('showNextLinks').checked\n      }[link.kind];\n    };\n\n    function renderGraph(data) {\n      const graph = new ___GraphRenderer___()\n        (document.getElementById('graph'))\n        .graphData(data)\n        .backgroundColor('#001')\n        .linkAutoColorBy('kind')\n        .nodeAutoColorBy('rootId')\n        .linkLabel('kind')\n        .linkVisibility(visibilityChecker)\n        .linkDirectionalParticles(1)\n        .nodeLabel(({ id, name, tags, image_url }) => `\n          <div class=\"relative\" style=\"width: 200px;\">\n            <img src=\"${image_url}\" style=\"opacity: 0.5; width: 200px\">\n            <div class=\"absolute topleft\" style=\"width: 190px; padding: 5px;\">\n              <div>${name || '[Untitled]'}</div>\n              <div class=\"smol\">${tags || '(no style)'}</div>\n            </div>\n          </div>\n          <div class=\"smol\">\n            Click to play, right-click to open in Suno\n          </div>\n        `)\n        .onNodeClick(({ id, name, tags, image_url, audio_url }) => {\n          document.getElementById('audioContainer').style.display = 'block';\n          document.getElementById('audioLink').href = `https://suno.com/song/${id}`;\n          document.getElementById('audioImage').src = image_url;\n          document.getElementById('audioName').innerText = name || '[Untitled]';\n          document.getElementById('audioTags').innerText = tags || '(no style)';\n          const audio = document.getElementById('audio');\n          audio.src = audio_url;\n          audio.play();\n        })\n        .onNodeRightClick(({ id }) => {\n          window.open(`https://suno.com/song/${id}`);\n        });\n      if ( use3DGraph ) {\n        graph.linkOpacity(l => l.isMain ? 1 : 0.2)\n      } else {\n        graph.linkLineDash(l => l.isMain ? undefined : [1, 2])\n      }\n      return graph;\n    };\n\n    document.querySelectorAll('[data-type=\"linkToggle\"]').forEach(checkbox => {\n      checkbox.addEventListener('change', () => {\n        const kind = checkbox.getAttribute('data-kind');\n        const useLinks = checkbox.checked;\n        let { nodes, links } = graph.graphData();\n        if ( !useLinks ) {\n          links = links.filter(l => l.kind !== kind);\n        } else {\n          links.push(...data.links.filter(l => l.kind === kind));\n        }\n        graph.graphData({ nodes, links });\n        if ( kind === 'next' ) {\n          document.getElementById('showNextLinksContainer').style.display = useLinks ? 'block' : 'none';\n        };\n      });\n    });\n\n    document.getElementById('showNextLinks').addEventListener('change', () => {\n      graph.linkVisibility(visibilityChecker);\n    });\n\n  </script>\n</body>"};
(()=>{function C(){return[]}function D(n,t){return t(n)}function B(n){return JSON.parse(JSON.stringify(n))}function R(n,t){Object.assign(n,t)}var v=0;function T(n){let t=Math.max(0,n-(Date.now()-v));return new Promise(e=>{setTimeout(()=>{v=Date.now(),e()},t)})}function l(n){throw new Error(n)}async function S(){let n=document.createElement("input");return n.type="file",n.click(),new Promise(t=>{n.onchange=()=>{let e=n.files?.[0];if(!e)return t(void 0);let i=new FileReader;i.onload=()=>{t(i.result),n.remove()},i.readAsText(e)}})}function P(n){return n?new Date(n).getTime():0}function k(n,t=e=>e.created_at){return n.sort((e,i)=>P(t(e))-P(t(i)))}async function U(n,t){for(let e of t.slice(t.findIndex(i=>i.id===n.id)+1))if(e!==n&&e.metadata.tags===n.metadata.tags&&await O(e.image_url,n.image_url))return console.warn(`Found potential base clip for cropped clip ${n.id}: ${e.id} (this is not guaranteed to be correct)`),e.id;console.warn(`Could not find a base clip for cropped clip ${n.id}, the clip will be mistakenly marked as a root clip.`)}async function $(n){let e=await(await fetch(n)).blob();return new Promise((i,s)=>{let o=new Image;o.onload=()=>{URL.revokeObjectURL(o.src),i(o)},o.onerror=s,o.src=URL.createObjectURL(e)})}async function O(n,t){let e=await $(n),i=await $(t),s=document.createElement("canvas");s.width=e.width,s.height=e.height;let o=s.getContext("2d")??l("Canvas 2D context not supported");o.drawImage(e,0,0);let r=o.getImageData(0,0,e.width,e.height);o.drawImage(i,0,0);let c=o.getImageData(0,0,i.width,i.height),a=r.data,y=c.data,p=a.length,d=0;for(let u=0;u<p;u+=4)for(let g=0;g<3;g++)d+=Math.abs(a[u+g]-y[u+g]);let E=d/(p/4);return s.remove(),E<32;}function h(n,t){return n.find(M(t))}function M(n){return function(t){return Object.entries(n).every(([e,i])=>t[e]===i)}}function x(){return window.suno??l("`suno` object not found in `window`. Have you followed the setup instructions?")}var f=class{resolve;reject;promise;constructor(){this.promise=new Promise((t,e)=>Object.assign(this,{resolve:t,reject:e}))}};var F="vovas",w="sunoTools",A=new Promise((n,t)=>{let e=indexedDB.open(F,1);e.onupgradeneeded=()=>e.result.createObjectStore(w),e.onsuccess=()=>n(e.result),e.onerror=()=>t(e.error)});async function j(n){return(await A).transaction(w,n)}async function G(n){return(await j(n)).objectStore(w)}var m=class{constructor(t,e){this.key=t;this.init=e}async load(){let t=(await G("readonly")).get(this.key);return new Promise((e,i)=>{t.onsuccess=()=>e(t.result??this.init),t.onerror=()=>i(t.error)})}async save(t){let e=await j("readwrite");return e.objectStore(w).put(t,this.key),new Promise((i,s)=>{e.oncomplete=()=>i(),e.onerror=()=>s(e.error)})}};function I(n,t){return Object.keys(t).reduce((e,i)=>e.replace(`___${i}___`,t[i]),n)}var L={rawClips:C(),lastProcessedPage:-1,allPagesProcessed:!1,links:C(),allLinksBuilt:!1},b=class{constructor(t=L){this.state=t;this.loadState()}reset(){this.state=L,console.log("Colony reset. Run build() to start building it again.")}storage=new m("colony",L);stateLoaded=new f;async loadState(t=!1){if(t){let e=await S();if(!e){console.log("No file selected, aborting.");return}this.state=JSON.parse(e)}else this.state=await this.storage.load();this.stateLoaded.resolve()}async saveState(t=!1){if(t){let e=JSON.stringify(this.state),i=new Blob([e],{type:"application/json"}),s=URL.createObjectURL(i),o=document.createElement("a");o.href=s,o.download="suno_colony.json",o.click(),URL.revokeObjectURL(s)}else await this.storage.save(this.state)}async build(){this.state.allPagesProcessed||await this.fetchClips(),this.state.allLinksBuilt||await this.buildLinks()}async fetchClips(){for(console.log("Fetching liked clips...");;){await T(1e3);let{data:{clips:t}}=await x().root.apiClient.GET("/api/feed/v2",{params:{query:{is_liked:!0,page:this.state.lastProcessedPage+1}}});if(!t.length){this.state.allPagesProcessed=!0;break}this.state.rawClips.push(...t),this.state.lastProcessedPage++,console.log(`Processed page ${this.state.lastProcessedPage}; total clips: ${this.state.rawClips.length}`)}}rawClipsById={};async loadClip(t){await T(1e3);console.log(`Clip ${t} not found in cache, loading...`);let e=await x().root.clips.loadClipById(t)??N(t);return this.state.rawClips.push(e),e}getClipByIdSync(t){t.startsWith("m_")&&(t=t.slice(2));return this.rawClipsById[t]??=this.state.rawClips.find(e=>K(t)?e.audio_url.includes(t):e.id===t)}async getClipById(t){return this.getClipByIdSync(t)??await this.loadClip(t)}async buildLinks(){console.log("Building links...");for(let t=0;t<this.state.rawClips.length;t++){let e=this.state.rawClips[t];t%100===0&&console.log(`Processed ${t} clips out of ${this.state.rawClips.length}`);let{metadata:i}=e,[s,o]="history"in i?D(i.history[0],r=>typeof r=="string"?[r,"extend"]:r.infill?[r.id,"inpaint"]:[r.id,"extend"]):"concat_history"in i?[i.concat_history[1].id,"apply"]:"cover_clip_id"in i?[i.cover_clip_id,"cover"]:"upsample_clip_id"in i?[i.upsample_clip_id,"remaster"]:"type"in i&&i.type==="edit_crop"?await U(e,this.state.rawClips).then(r=>r?[r,"crop"]:[void 0,void 0]):[void 0,void 0];s&&this.state.links.push([(await this.getClipById(s)).id,e.id,o])}this.state.allLinksBuilt=!0,console.log(`Built ${this.state.links.length} links.`)}_linkedClips;get linkedClips(){return this._linkedClips??=this.getLinkedClips()}getLinkedClips(){let t=this.state.links.reduce((i,[s,o,r])=>{let c=h(i,{id:s})??l(`Could not find parent for link ${s} -> ${o}.`),a=h(i,{id:o})??l(`Could not find child for link ${s} -> ${o}.`);if(a.parent)throw new Error(`Child ${o} already has a parent: ${a.parent.clip.id}`);return a.parent={kind:r,clip:c},(c.children??=[]).push({kind:r,clip:a}),i},B(this.state.rawClips));for(let i of t.filter(({parent:s})=>!s))e(i,i);return t;function e(i,s){Object.assign(i,{root:s});for(let{clip:o}of i.children??[])e(o,s)}}_rootClips;get rootClips(){return this._rootClips??=this.getRootClips()}getRootClips(){let t=this.linkedClips.filter(({parent:e})=>!e);return k(t)}get sortedClips(){let t=[],{rootClips:e}=this;for(let s of e)i(s);return t.reverse();function i(s){t.push(s);let{children:o}=s;if(o)for(let{clip:r}of k(o,({clip:c})=>c.created_at))i(r)}}get syntheticLinks(){let t=[],{rootClips:e}=this,i=e[0];for(let s of e.slice(1))t.push([i.id,s.id,"next"]),s?.children?.length&&(i=s);for(let s of this.linkedClips.filter(({children:o})=>o?.length))t.push([(s.root??l(`Clip ${s.id} has no root.`)).id,s.id,"descendant"]);return t}getTotalDescendants(t){let e=h(this.linkedClips,{id:t})??l(`Clip ${t} not found.`);return e.totalDescendants??=1+(e.children?.reduce((i,{clip:{id:s}})=>i+this.getTotalDescendants(s),0)??0)}get graphData(){let t=([s,o,r])=>({source:s,target:o,kind:r,color:r==="next"?"#006":void 0}),e=this.state.links.map(t).map(s=>({...s,isMain:this.getTotalDescendants(s.target)>1}));return{nodes:this.sortedClips.map(({id:s,title:o,metadata:{tags:r},created_at:c,children:a,audio_url:y,image_url:p,root:d})=>({id:s,name:o||r||c||s,audio_url:y,image_url:p,tags:r,rootId:d?.id,val:s===d?.id&&a?.length?2:a?.length?1:.5})),links:[...this.syntheticLinks.map(t),...e]}}render(t){let e=window.open();if(!e){console.error("Failed to open new window.");return}let i=t?.toLowerCase()==="3d";e.document.write(I(window.templates.colony,{data:JSON.stringify(this.graphData),use3DGraph:String(i),GraphRenderer:i?"ForceGraph3D":"ForceGraph",graph_url_slug:i?"3d-force-graph":"force-graph"}))}},_=new b;_.stateLoaded.promise.then(()=>{console.log("Colony state loaded");let{state:{allPagesProcessed:n,allLinksBuilt:t}}=_;console.log(!n||!t?"Colony state is incomplete. Run `await vovas.colony.build()` to complete it.":"Colony state is complete, you can now run `await vovas.colony.openHtml()` to view the colony.")});function K(n){return n.match(/_\d+$/)}function N(n){return console.warn(`Clip ${n} not found, creating a missing clip.`),{isMissing:!0,id:n,title:"*Clip not found*",created_at:null,audio_url:`https://cdn1.suno.ai/${n}.mp3`,image_url:"",metadata:{duration:0,tags:""}}}R(window,{vovas:{colony:_}});})();
