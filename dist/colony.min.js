(vovas = { main() {
(()=>{function I(n,e){return n.find(Be(e))}function Be(n){return function(e){return Object.entries(n).every(([t,o])=>e[t]===o)}}var $e=0;function ae(n=""){return`${n}${++$e}`}function q(n,e){return Object.fromEntries(Object.entries(n).map(([t,o])=>[t,e(o,t)]))}function J(n,e){return q(n,e)}function le(n,e){return Object.fromEntries(Object.entries(n).map(([t,o])=>[e(t,o),o]))}function Y(n){return typeof n=="function"}function ce(n,e){return Object.assign(n,e)}function Q(){return[]}function ue(n,e){return e(n)}function U(n){return JSON.parse(JSON.stringify(n))}function fe(n,e){Object.assign(n,e)}var de=0;function X(n){let e=Math.max(0,n-(Date.now()-de));return new Promise(t=>{setTimeout(()=>{de=Date.now(),t()},e)})}function b(n){throw new Error(n)}async function ye(){let n=document.createElement("input");return n.type="file",n.click(),new Promise(e=>{n.onchange=()=>{let t=n.files?.[0];if(!t)return e(void 0);let o=new FileReader;o.onload=()=>{e(o.result),n.remove()},o.readAsText(t)}})}function pe(n){return n?new Date(n).getTime():0}function L(n,e=t=>t.created_at){return n.sort((t,o)=>pe(e(t))-pe(e(o)))}function Te(n,e){return le(n,t=>e[t]??t)}async function me(n,e){for(let t of e.slice(e.findIndex(o=>o.id===n.id)+1))if(t!==n&&t.metadata.tags===n.metadata.tags&&await Oe(t.image_url,n.image_url))return console.warn(`Found potential base clip for cropped clip ${n.id}: ${t.id} (this is not guaranteed to be correct)`),t.id;console.warn(`Could not find a base clip for cropped clip ${n.id}, the clip will be mistakenly marked as a root clip.`)}async function he(n){let t=await(await fetch(n)).blob();return new Promise((o,i)=>{let s=new Image;s.onload=()=>{URL.revokeObjectURL(s.src),o(s)},s.onerror=i,s.src=URL.createObjectURL(t)})}async function Oe(n,e){let t=await he(n),o=await he(e),i=document.createElement("canvas");i.width=t.width,i.height=t.height;let s=i.getContext("2d")??b("Canvas 2D context not supported");s.drawImage(t,0,0);let r=s.getImageData(0,0,t.width,t.height);s.drawImage(o,0,0);let c=s.getImageData(0,0,o.width,o.height),d=r.data,x=c.data,w=d.length,m=0;for(let k=0;k<w;k+=4)for(let v=0;v<3;v++)m+=Math.abs(d[k+v]-x[k+v]);let D=m/(w/4);return i.remove(),D<32;}var _=class{resolve;reject;promise;constructor(){this.promise=new Promise((e,t)=>Object.assign(this,{resolve:e,reject:t}))}};var je="vovas",E="sunoTools",He=new Promise((n,e)=>{let t=indexedDB.open(je,1);t.onupgradeneeded=()=>t.result.createObjectStore(E),t.onsuccess=()=>n(t.result),t.onerror=()=>e(t.error)});async function Z(n){return(await He).transaction(E,n)}function ge(n){return new Promise((e,t)=>{n.oncomplete=()=>e(),n.onerror=()=>t(n.error)})}async function We(n){return(await Z(n)).objectStore(E)}var N=class{constructor(e,t){this.key=e;this.init=t}async load(){let e=(await We("readonly")).get(this.key);return new Promise((t,o)=>{e.onsuccess=()=>t(e.result??this.init),e.onerror=()=>o(e.error)})}async save(e){let t=await Z("readwrite");return t.objectStore(E).put(e,this.key),ge(t)}async clear(){let e=await Z("readwrite");return e.objectStore(E).delete(this.key),ge(e)}};var F=class extends Error{constructor(e){super(`smork: ${e}`)}};function C(n,e){return Y(n)?xe(n,e):new K(n)}var S=class{constructor(e){this._value=e}watchers=new Set;activeWatchers=new WeakSet;get(){return A?.(this),this._value}_set(e){let{_value:t}=this;if(e!==this._value){this._value=e;try{for(let o of this.watchers){if(this.activeWatchers.has(o)){console.warn("smork: watcher is already active \u2014 perhaps a circular dependency \u2014 exiting watch to prevent infinite loop");return}this.activeWatchers.add(o),o(e,t)}}finally{this.activeWatchers=new WeakSet}}}runAndWatch(e){e(this._value,this._value),this.watch(e)}watchImmediate=this.runAndWatch;watch(e){this.watchers.add(e)}onChange=this.watch;unwatch(e){this.watchers.delete(e)}get value(){return this.get()}map(e){return new ee(this,e)}merge(e){return e?xe(()=>({...this.value,...Ge(e)})):this}uses(e){return ce(this,q(e,this.map))}},ee=class extends S{constructor(t,o){super(o(t.value));this.parent=t;t.watch(i=>this._set(o(i)))}},K=class extends S{set(e){this._set(e)}set value(e){this.set(e)}get value(){return this.get()}bridge(e,t){return new $(()=>e(this.value),o=>this.set(t(o)))}};var A,B=class extends K{constructor(t){super(void 0);this.getter=t;this.track()}dependencies=new Set;track=()=>{if(A)throw new F("Tried to compute a ref while another one is already being computed \u2014 did you nest a computed ref in another ref's getter function?");this.dependencies.forEach(t=>t.unwatch(this.track)),this.dependencies=new Set;try{A=t=>{t.watch(this.track),this.dependencies.add(t)},this._set(this.getter())}finally{A=void 0}}},$=class extends K{constructor(t,o,i=!1){let s=new B(t);super(s.value);this.setter=o;this.allowMismatch=i;s.watch(r=>this._set(r))}set(t){if(this.setter(t),!this.allowMismatch&&this.value!==t)throw new F("Setter did not update the value. If you want to allow this, set the allowMismatch property to true.")}};function xe(n,e){return e?new $(n,e):new B(n)}function we(n){return(e,t,o)=>n instanceof S?e(n):Y(n)?t(n):o(n)}function Ge(n){return we(n)(e=>e.value,e=>e(),e=>e)}function ke(n,e){we(n)(t=>t.watchImmediate(e),t=>C(t).watchImmediate(e),e)}var Ve=["html","head","style","script","body","div","h3","p","a","img","audio","input","label","button"],ze=Je(Ve),{html:kt,head:vt,style:ve,script:bt,body:Ct,div:y,h3:be,p:Ce,a:Re,img:Le,audio:Ee,input:Rt,label:qe,button:P}=ze;function Je(n){return n.reduce((e,t)=>Object.assign(e,{[t]:Se(t)}),{})}function Se(n){function e(o,i,s){let[r,c,d]=Array.isArray(o)?[void 0,void 0,o]:Array.isArray(i)?[o,void 0,i]:[o,i,s];return t(r,c,d)}return e;function t(o,i,s){let r=document.createElement(n);return i&&Object.assign(r,i),o&&J(Te(o,{class:"className",for:"htmlFor"}),(c,d)=>{ke(c,x=>{d!=="style"?r[d]=x:J(x,(w,m)=>r.style[m]=w)})}),s&&s.forEach(c=>{typeof c=="string"?r.appendChild(document.createTextNode(c)):r.appendChild(c)}),r}}var O=Pe("input","checked",{type:"checkbox"},n=>({onchange:()=>n.set(!n.value)})),Ke=Pe("input","value",{type:"text"},n=>({onkeyup:({key:e,target:t})=>{e==="Enter"&&t instanceof HTMLInputElement&&n.set(t.value)}}));function Pe(n,e,t,o){return(i,s)=>Se(n)({...t,...s,[e]:i},o(i))}function j(n,e){e.id||=ae("smork-input-");let t=[qe({for:e.id},[n]),e];return e.type==="checkbox"&&t.reverse(),t}async function De(n,e,t){let o=n.document.createElement("script");return o.type="text/javascript",o.src=t,n.document.head.appendChild(o),new Promise(i=>{o.onload=()=>{i(n[e])}})}var Me='.colony { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;}.colony button {background-color: #444;color: #eee}.colony #sidebar {position: fixed;padding: 10px;top: 0;left: 0;bottom: 0;width: 200px;background-color: #333;color: #eee;display: flex;flex-direction: column;justify-content: space-between;}.colony .f-row {display: flex;flex-direction: row;}.colony .f-col {display: flex;flex-direction: column;}.colony .smol {font-size: 0.8em;color: #aaa;}.colony .relative {position: relative;}.colony .absolute {position: absolute;}.colony .topleft {top: 0;left: 0;}.colony .p-1 {padding: 1rem;};.colony .p-2 {padding: 2rem;}.colony .w-100 {width: 100%;}.colony .h-100 {height: 100%;}.colony .j-between {justify-content: space-between;}.colony .settings > * {margin-top: 5px;}';async function te(n,e,{mode:t=void 0}){let o=t?.toLowerCase()==="3d",i=C(!1),s,r=C(!0),c=C(!1),d=C(!0),x=C(""),w,m,D,k,v,G,Ue=await De(window,"ForceGraph",`https://unpkg.com/${o?"3d-":""}force-graph`);window.document.head.appendChild(ve([Me]));let ie=y({class:"colony",style:{position:"fixed",top:"0px",left:"0px",zIndex:"100"}},[y({style:i.map(a=>({flexDirection:"column",height:"100vh",width:"100vh",backgroundColor:"#000",display:a?"none":"flex"}))},[s=y(),y({id:"sidebar"},[y({class:"settings f-col"},[P({style:{marginBottom:"5px"}},{onclick:()=>i.set(!0)},["Close Colony"]),be(["Settings"]),y(j("Attract based on time",O(r))),y({style:r.map(a=>({display:a?"block":"none"}))},j("Show time-based links",O(c))),y(j("Attract to root clip",O(d))),y([Ke(x,{placeholder:"Filter by name, style or ID"}),Ce({class:"smol"},["Enter to apply. (Filter will include both matching nodes and any nodes belonging to the same root clip.)"])]),P({},{onclick:Ae},["Redraw"]),P({},{onclick:()=>n.renderToFile(t)},["Download"])]),w=y({class:"w-100",style:{display:"none"}},[y({class:"relative"},[m=Re({target:"_blank"},[D=Le({style:"opacity: 0.5",class:"w-100"})]),y({class:"absolute topleft",style:"width: 190px; padding: 5px;"},[k=y(),v=y({class:"smol"})])]),G=Ee({controls:!0,class:"w-100"})])])]),P({style:i.map(a=>({position:"fixed",top:"0px",left:"0px",padding:"5px",zIndex:"100",display:a?"block":"none"}))},{onclick:()=>i.set(!1)},["Reopen Colony"])]);document.body.appendChild(ie);let _e=U(e);let g=Ne();function Ne(){let a=new Ue(s).graphData(_e).backgroundColor("#001").linkAutoColorBy("kind").nodeAutoColorBy("rootId").linkLabel("kind").linkVisibility(se).linkDirectionalParticles(1).nodeLabel(({id:p,name:T,tags:f,image_url:u})=>`
        <div class="relative" style="width: 200px;">
          <img src="${u}" style="opacity: 0.5; width: 200px">
          <div class="absolute topleft" style="width: 190px; padding: 5px;">
            <div>${T||"[Untitled]"}</div>
            <div class="smol">${f||"(no style)"}</div>
          </div>
        </div>
        <div class="smol">
          Click to play, right-click to open in Suno
        </div>
      `).onNodeClick(({id:p,name:T,tags:f,image_url:u,audio_url:l})=>{w.style.display="block",m.href=`https://suno.com/song/${p}`,D.src=u,k.innerText=T||"[Untitled]",v.innerText=f||"(no style)",G.src=l,G.play()}).onNodeRightClick(({id:p})=>{window.open(`https://suno.com/song/${p}`)});return o?a.linkOpacity(p=>p.isMain?1:.2):a.linkLineDash(p=>p.isMain?null:[1,2]),a}async function Ae(){new FinalizationRegistry(()=>console.log("Previous graph destroyed, container removed from memory")).register(g,""),g._destructor(),ie.remove(),await te.call(this,e,{in3D:o})}let R=g.graphData();function se(a){return!{descendant:!0,next:!c.value}[a.kind]}function re(a,p){let{nodes:T,links:f}=g.graphData();if(p?f.push(...R.links.filter(u=>u.kind===a)):f=f.filter(u=>u.kind!==a),a==="next"&&(f=f.filter(u=>u.kind!=="next"),p)){L(T);for(let u=1;u<T.length;u++){let l=T[u-1],h=T[u];f.push({source:l.id,target:h.id,kind:"next",color:"#006",isMain:!1})}}g.graphData({nodes:T,links:f})}r.watchImmediate(a=>re("next",a)),d.watchImmediate(a=>re("descendant",a)),c.watchImmediate(()=>{g.linkVisibility(se)});function M(a){return typeof a=="string"?a:a.id}function V(a,p){return M(a)===M(p)}function z(a){return p=>V(a,p)}x.watchImmediate(a=>{a=a?.toLowerCase();let p=a?R.nodes.filter(l=>`${l.id} ${l.name} ${l.tags} ${l.created_at}`.toLowerCase().includes(a)):R.nodes,T=g.graphData(),f=[...p.map(l=>T.nodes.find(z(l))??l),...a?R.nodes.filter(l=>p.some(h=>h.rootId===l.rootId&&h.id!==l.id)):[]].map(l=>T.nodes.find(h=>h.id===l.id)??l),u=R.links.filter(l=>f.some(z(l.source))&&f.some(z(l.target))).map(({source:l,target:h,...Fe})=>({source:M(l),target:M(h),...Fe})).map(l=>T.links.find(h=>V(l.source,h.source)&&V(l.target,h.target))??l);g.graphData({nodes:f,links:u}),a?g.nodeVal(l=>p.some(h=>h.id===l.id)?3:l.val):g.nodeVal("val")}),setTimeout(()=>{r.set(!1),d.set(!1)},2e3);}var Qe="https://studio-api.prod.suno.com/api/";function Ie(n,e){return async(...t)=>{let o=n(...t),i=await fetch(Qe+o,{headers:{authorization:`Bearer ${await window.Clerk.session.getToken()}`}});if(i.status===404&&e){console.warn(`Could not find resource at ${o}, returning undefined`);return}return await i.json()}}var ne={getClips:Ie(n=>"feed/v2?is_liked=true&page="+n),getClip:Ie(n=>"clip/"+n,!0)};var Xe=["next","descendant"];var oe={rawClips:Q(),lastProcessedPage:-1,allPagesProcessed:!1,links:Q(),allLinksBuilt:!1},W=class{constructor(e=oe){this.state=e;this.loadState()}reset(){this.state=oe,console.log("Colony reset. Run build() to start building it again.")}storage=new N("colony",oe);stateLoaded=new _;async loadState(e=!1){if(e){let t=await ye();if(!t){console.log("No file selected, aborting.");return}this.state=JSON.parse(t)}else this.state=await this.storage.load();this.stateLoaded.resolve()}async saveState(e=!1){if(e){let t=JSON.stringify(this.state),o=new Blob([t],{type:"application/json"}),i=URL.createObjectURL(o),s=document.createElement("a");s.href=i,s.download="suno_colony.json",s.click(),URL.revokeObjectURL(i)}else await this.storage.save(this.state)}async build(){try{this.state.allPagesProcessed||await this.fetchClips(),this.state.allLinksBuilt||await this.buildLinks()}finally{await this.saveState()}}async fetchClips(){for(console.log("Fetching liked clips...");;){await X(1e3);let{clips:e}=await ne.getClips(this.state.lastProcessedPage+1);if(!e.length){this.state.allPagesProcessed=!0;break}this.state.rawClips.push(...e),this.state.lastProcessedPage++,console.log(`Processed page ${this.state.lastProcessedPage}; total clips: ${this.state.rawClips.length}`)}}rawClipsById={};async loadClip(e){await X(1e3);console.log(`Clip ${e} not found in cache, loading...`);let t=await ne.getClip(e)??et(e);return this.state.rawClips.push(t),t}getClipByIdSync(e){return this.rawClipsById[e]??=this.state.rawClips.find(t=>Ze(e)?t.audio_url.includes(e):t.id===e)}async getClipById(e){return e.startsWith("m_")&&(e=e.slice(2)),this.getClipByIdSync(e)??await this.loadClip(e)}async buildLinks(){console.log("Building links...");for(let e=0;e<this.state.rawClips.length;e++){let t=this.state.rawClips[e];e%100===0&&console.log(`Processed ${e} clips out of ${this.state.rawClips.length}`);let{metadata:o}=t,[i,s]="history"in o?ue(o.history[0],r=>typeof r=="string"?[r,"extend"]:r.infill?[r.id,"inpaint"]:[r.id,"extend"]):"concat_history"in o?[o.concat_history[1].id,"apply"]:"cover_clip_id"in o?[o.cover_clip_id,"cover"]:"upsample_clip_id"in o?[o.upsample_clip_id,"remaster"]:"type"in o&&o.type==="edit_crop"?await me(t,this.state.rawClips).then(r=>r?[r,"crop"]:[void 0,void 0]):[void 0,void 0];i&&this.state.links.push([(await this.getClipById(i)).id,t.id,s])}this.state.allLinksBuilt=!0,console.log(`Built ${this.state.links.length} links.`),console.log("Colony built. Run `await vovas.colony.render()` to view it!")}_linkedClips;get linkedClips(){return this._linkedClips??=this.getLinkedClips()}getLinkedClips(){let e=this.state.links.reduce((o,[i,s,r])=>{let c=I(o,{id:i})??b(`Could not find parent for link ${i} -> ${s}.`),d=I(o,{id:s})??b(`Could not find child for link ${i} -> ${s}.`);if(d.parent)throw new Error(`Child ${s} already has a parent: ${d.parent.clip.id}`);return d.parent={kind:r,clip:c},(c.children??=[]).push({kind:r,clip:d}),o},U(this.state.rawClips));for(let o of e.filter(({parent:i})=>!i))t(o,o);return e;function t(o,i){Object.assign(o,{root:i});for(let{clip:s}of o.children??[])t(s,i)}}_rootClips;get rootClips(){return this._rootClips??=this.getRootClips()}getRootClips(){let e=this.linkedClips.filter(({parent:t})=>!t);return L(e)}get sortedClips(){let e=[],{rootClips:t}=this;for(let i of t)o(i);return e.reverse();function o(i){e.push(i);let{children:s}=i;if(s)for(let{clip:r}of L(s,({clip:c})=>c.created_at))o(r)}}get syntheticLinks(){let e=[],{rootClips:t}=this,o=t[0];for(let i of this.linkedClips.filter(({children:s})=>s?.length))e.push([(i.root??b(`Clip ${i.id} has no root.`)).id,i.id,"descendant"]);return e}getTotalDescendants(e){let t=I(this.linkedClips,{id:e})??b(`Clip ${e} not found.`);return t.totalDescendants??=1+(t.children?.reduce((o,{clip:{id:i}})=>o+this.getTotalDescendants(i),0)??0)}_graphData=void 0;getGraphData(){let e=this.sortedClips.map(({id:i,title:s,metadata:{tags:r},created_at:c,children:d,audio_url:x,image_url:w,root:m})=>({id:i,name:s||r||c||i,created_at:c,audio_url:x,image_url:w,tags:r,rootId:m?.id,val:i===m?.id&&d?.length?2:d?.length?1:.5})),t=([i,s,r])=>({source:i,target:s,kind:r,color:r==="next"?"#006":void 0,isMain:!Xe.includes(r)&&this.getTotalDescendants(s)>1});return{nodes:e,links:[...this.syntheticLinks,...this.state.links].map(t)}}get graphData(){return this._graphData??=this.getGraphData()}getHtml(e){return console.log("Rendering your colony, give it a few seconds..."),`<script>(vovas = {${window.vovas.main.toString()}}).main();vovas.colony.render(...${JSON.stringify([e,this.graphData])})<\/script>`}async render(e,t){console.log("Rendering your colony, give it a few seconds..."),this._graphData??=t,await te(this,this.graphData,{mode:e})}renderToFile(...e){let t=this.getHtml(...e),o=new Blob([t],{type:"text/html"}),i=URL.createObjectURL(o),s=document.createElement("a");s.href=i,s.download="suno_colony.html",s.click(),URL.revokeObjectURL(i)}},H=new W;H.stateLoaded.promise.then(()=>{console.log("Welcome to Vova\u2019s Suno Colony! This is a nifty tool to visualize your liked clips and the relationships between them, such as extensions, inpaints, covers, etc., in a graph format. It takes a bit of time and hacks to build, but hopefully it\u2019ll be worth it!");let{state:{allPagesProcessed:n,allLinksBuilt:e}}=H;if(!n||!e)console.log("Run `await vovas.colony.build()` to start or continue building your colony!");else return console.log("Your colony is built, rendering!"),H.render()});function Ze(n){return n.match(/_\d+$/)}function et(n){return console.warn(`Clip ${n} not found, creating a missing clip.`),{isMissing:!0,id:n,title:"*Clip not found*",created_at:null,audio_url:`https://cdn1.suno.ai/${n}.mp3`,image_url:"",metadata:{duration:0,tags:""}}}fe(window.vovas,{Colony:W,colony:H});})();
}}).main();
