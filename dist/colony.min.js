(()=>{function A(i,e){return i.find(Ht(e))}function Ht(i){return function(e){return Object.entries(i).every(([n,s])=>e[n]===s)}}function X(){return[]}function mt(i,e){return e(i)}function yt(i){return JSON.parse(JSON.stringify(i))}function Z(i,e){Object.assign(i,e)}var ht=0;function tt(i){let e=Math.max(0,i-(Date.now()-ht));return new Promise(n=>{setTimeout(()=>{ht=Date.now(),n()},e)})}function D(i){throw new Error(i)}async function gt(){let i=document.createElement("input");return i.type="file",i.click(),new Promise(e=>{i.onchange=()=>{let n=i.files?.[0];if(!n)return e(void 0);let s=new FileReader;s.onload=()=>{e(s.result),i.remove()},s.readAsText(n)}})}function ft(i){return i?new Date(i).getTime():0}function et(i,e=n=>n.created_at){return i.sort((n,s)=>ft(e(n))-ft(e(s)))}async function kt(i,e){for(let n of e.slice(e.findIndex(s=>s.id===i.id)+1))if(n!==i&&n.metadata.tags===i.metadata.tags&&await qt(n.image_url,i.image_url))return console.warn(`Found potential base clip for cropped clip ${i.id}: ${n.id} (this is not guaranteed to be correct)`),n.id;console.warn(`Could not find a base clip for cropped clip ${i.id}, the clip will be mistakenly marked as a root clip.`)}async function wt(i){let n=await(await fetch(i)).blob();return new Promise((s,a)=>{let l=new Image;l.onload=()=>{URL.revokeObjectURL(l.src),s(l)},l.onerror=a,l.src=URL.createObjectURL(n)})}async function qt(i,e){let n=await wt(i),s=await wt(e),a=document.createElement("canvas");a.width=n.width,a.height=n.height;let l=a.getContext("2d")??D("Canvas 2D context not supported");l.drawImage(n,0,0);let p=l.getImageData(0,0,n.width,n.height);l.drawImage(s,0,0);let y=l.getImageData(0,0,s.width,s.height),T=p.data,_=y.data,S=T.length,R=0;for(let I=0;I<S;I+=4)for(let K=0;K<3;K++)R+=Math.abs(T[I+K]-_[I+K]);let j=R/(S/4);return a.remove(),j<32;}function nt(){return window.suno??D("`suno` object not found in `window`. Have you followed the setup instructions?")}var F=class{resolve;reject;promise;constructor(){this.promise=new Promise((e,n)=>Object.assign(this,{resolve:e,reject:n}))}};var Jt="vovas",B="sunoTools",zt=new Promise((i,e)=>{let n=indexedDB.open(Jt,1);n.onupgradeneeded=()=>n.result.createObjectStore(B),n.onsuccess=()=>i(n.result),n.onerror=()=>e(n.error)});async function it(i){return(await zt).transaction(B,i)}function Tt(i){return new Promise((e,n)=>{i.oncomplete=()=>e(),i.onerror=()=>n(i.error)})}async function Yt(i){return(await it(i)).objectStore(B)}var W=class{constructor(e,n){this.key=e;this.init=n}async load(){let e=(await Yt("readonly")).get(this.key);return new Promise((n,s)=>{e.onsuccess=()=>n(e.result??this.init),e.onerror=()=>s(e.error)})}async save(e){let n=await it("readwrite");return n.objectStore(B).put(e,this.key),Tt(n)}async clear(){let e=await it("readwrite");return e.objectStore(B).delete(this.key),Tt(e)}};function ot(){window.render_compiled=arguments.callee,(()=>{var i=0;function e(t=""){return`${t}${++i}`}function n(t,o){return Object.fromEntries(Object.entries(t).map(([r,d])=>[r,o(d,r)]))}function s(t,o){return n(t,o)}function a(t,o){return Object.fromEntries(Object.entries(t).map(([r,d])=>[o(r,d),d]))}function l(t){return typeof t=="function"}var p=class extends Error{constructor(t){super(`smork: ${t}`)}};function y(t,o){return l(t)?I(t,o):new _(t)}var T=class{constructor(t){this._value=t}watchers=new Set;activeWatchers=new WeakSet;get(){return S?.(this),this._value}_set(t){let{_value:o}=this;if(t!==this._value){this._value=t;try{for(let r of this.watchers){if(this.activeWatchers.has(r)){console.warn("smork: watcher is already active \u2014 perhaps a circular dependency \u2014 exiting watch to prevent infinite loop");return}this.activeWatchers.add(r),r(t,o)}}finally{this.activeWatchers=new WeakSet}}}runAndWatch(t){t(this._value,this._value),this.watch(t)}watchImmediate=this.runAndWatch;watch(t){this.watchers.add(t)}onChange=this.watch;unwatch(t){this.watchers.delete(t)}get value(){return this.get()}map(t){return new R(()=>t(this.value))}compute=this.map;merge(t){return t?I(()=>({...this.value,...bt(t)})):this}},_=class extends T{set(t){this._set(t)}set value(t){this.set(t)}get value(){return this.get()}bridge(t,o){return new j(()=>t(this.value),r=>this.set(o(r)))}},S=void 0,R=class extends _{constructor(t){super(void 0),this.getter=t,this.track()}dependencies=new Set;track=()=>{if(S)throw new p("Tried to compute a ref while another one is already being computed \u2014 did you nest a computed ref in another ref's getter function?");this.dependencies.forEach(t=>t.unwatch(this.track)),this.dependencies=new Set;try{S=t=>{t.watch(this.track),this.dependencies.add(t)},this._set(this.getter())}finally{S=void 0}}},j=class extends _{constructor(t,o,r=!1){let d=new R(t);super(d.value),this.setter=o,this.allowMismatch=r,d.watch(m=>this._set(m))}set(t){if(this.setter(t),!this.allowMismatch&&this.value!==t)throw new p("Setter did not update the value. If you want to allow this, set the allowMismatch property to true.")}};function I(t,o){return o?new j(t,o):new R(t)}function K(t){return(o,r,d)=>t instanceof T?o(t):l(t)?r(t):d(t)}function bt(t){return K(t)(o=>o.value,o=>o(),o=>o)}function vt(t,o){K(t)(r=>r.watchImmediate(o),r=>y(r).watchImmediate(o),o)}function Ct(t){throw new Error(t)}function rt(t){return t?new Date(t).getTime():0}function Lt(t,o=r=>r.created_at){return t.sort((r,d)=>rt(o(r))-rt(o(d)))}function St(t,o){return a(t,r=>o[r]??r)}var Rt=["html","head","style","script","body","div","h3","p","a","img","audio","input","label","button"],Dt=jt(Rt),{html:te,head:ee,style:_t,script:ne,body:ie,div:k,h3:It,p:Kt,a:Pt,img:Et,audio:$t,input:oe,label:Bt,button:U}=Dt;function jt(t){return t.reduce((o,r)=>Object.assign(o,{[r]:at(r)}),{})}function at(t){function o(d,m,v){let[b,C,P]=Array.isArray(d)?[void 0,void 0,d]:Array.isArray(m)?[d,void 0,m]:[d,m,v];return r(b,C,P)}return o;function r(d,m,v){let b=document.createElement(t);return m&&Object.assign(b,m),d&&s(St(d,{class:"className",for:"htmlFor"}),(C,P)=>{vt(C,E=>{P!=="style"?b[P]=E:s(E,(N,M)=>b.style[M]=N)})}),v&&v.forEach(C=>{typeof C=="string"?b.appendChild(document.createTextNode(C)):b.appendChild(C)}),b}}var H=lt("input","checked",{type:"checkbox"},t=>({onchange:()=>t.set(!t.value)})),Ut=lt("input","value",{type:"text"},t=>({onkeyup:({key:o,target:r})=>{o==="Enter"&&r instanceof HTMLInputElement&&t.set(r.value)}}));function lt(t,o,r,d){return(m,v)=>at(t)({...r,...v,[o]:m},d(m))}function q(t,o){o.id||=e("smork-input-");let r=[Bt({for:o.id},[t]),o];return o.type==="checkbox"&&r.reverse(),r}async function Nt(t,o,r){let d=t.document.createElement("script");return d.type="text/javascript",d.src=r,t.document.head.appendChild(d),new Promise(m=>{d.onload=()=>{m(t[o])}})}var Mt='.colony { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;}.colony button {background-color: #444;color: #eee}.colony #sidebar {position: fixed;padding: 10px;top: 0;left: 0;bottom: 0;width: 200px;background-color: #333;color: #eee;display: flex;flex-direction: column;justify-content: space-between;}.colony .f-row {display: flex;flex-direction: row;}.colony .f-col {display: flex;flex-direction: column;}.colony .smol {font-size: 0.8em;color: #aaa;}.colony .relative {position: relative;}.colony .absolute {position: absolute;}.colony .topleft {top: 0;left: 0;}.colony .p-1 {padding: 1rem;};.colony .p-2 {padding: 2rem;}.colony .w-100 {width: 100%;}.colony .h-100 {height: 100%;}.colony .j-between {justify-content: space-between;}.colony .settings > * {margin-top: 5px;}';async function ct(t,{in3D:o=!1}){let r=y(!1),d,m=y(!0),v=y(!1),b=y(!0),C=y(""),P,E,N,M,dt,J,Ft=await Nt(window,"ForceGraph",`https://unpkg.com/${o?"3d-":""}force-graph`);window.document.head.appendChild(_t([Mt]));let z=k({class:"colony",style:{position:"fixed",top:"0px",left:"0px",zIndex:"100"}},[k({style:r.map(c=>({flexDirection:"column",height:"100vh",width:"100vh",backgroundColor:"#000",display:c?"none":"flex"}))},[d=k(),k({id:"sidebar"},[k({class:"settings f-col"},[U({style:{marginBottom:"5px"}},{onclick:()=>r.set(!0)},["Close Colony"]),It(["Settings"]),k(q("Attract based on time",H(m))),k({style:m.map(c=>({display:c?"block":"none"}))},q("Show time-based links",H(v))),k(q("Attract to root clip",H(b))),k([Ut(C,{placeholder:"Filter by name, style or ID"}),Kt({class:"smol"},["Enter to apply. (Filter will include both matching nodes and any nodes belonging to the same root clip.)"])]),U({},{onclick:Vt},["Redraw"]),U({},{onclick(){let c=`<script>window.colonyData=${JSON.stringify({graphData:t,in3D:o})}<\/script><script>(${"render_compiled"in window&&typeof window.render_compiled=="function"?window.render_compiled.toString():Ct("render_compiled not found")})()<\/script>`,h=new Blob([c],{type:"text/html"}),g=URL.createObjectURL(h),f=document.createElement("a");f.href=g,f.download="suno_colony.html",f.click(),URL.revokeObjectURL(g)}},["Download"])]),P=k({class:"w-100",style:{display:"none"}},[k({class:"relative"},[E=Pt({target:"_blank"},[N=Et({style:"opacity: 0.5",class:"w-100"})]),k({class:"absolute topleft",style:"width: 190px; padding: 5px;"},[M=k(),dt=k({class:"smol"})])]),J=$t({controls:!0,class:"w-100"})])])]),U({style:r.map(c=>({position:"fixed",top:"0px",left:"0px",padding:"5px",zIndex:"100",display:c?"block":"none"}))},{onclick:()=>r.set(!1)},["Reopen Colony"])]);document.body.appendChild(z);let L=Wt();function Wt(){let c=new Ft(d).graphData(t).backgroundColor("#001").linkAutoColorBy("kind").nodeAutoColorBy("rootId").linkLabel("kind").linkVisibility(ut).linkDirectionalParticles(1).nodeLabel(({id:h,name:g,tags:f,image_url:w})=>`
        <div class="relative" style="width: 200px;">
          <img src="${w}" style="opacity: 0.5; width: 200px">
          <div class="absolute topleft" style="width: 190px; padding: 5px;">
            <div>${g||"[Untitled]"}</div>
            <div class="smol">${f||"(no style)"}</div>
          </div>
        </div>
        <div class="smol">
          Click to play, right-click to open in Suno
        </div>
      `).onNodeClick(({id:h,name:g,tags:f,image_url:w,audio_url:u})=>{P.style.display="block",E.href=`https://suno.com/song/${h}`,N.src=w,M.innerText=g||"[Untitled]",dt.innerText=f||"(no style)",J.src=u,J.play()}).onNodeRightClick(({id:h})=>{window.open(`https://suno.com/song/${h}`)});return o?c.linkOpacity(h=>h.isMain?1:.2):c.linkLineDash(h=>h.isMain?null:[1,2]),c}async function Vt(){new FinalizationRegistry(()=>console.log("Previous graph destroyed, container removed from memory")).register(L,""),L._destructor(),z.remove(),await ct(t,{in3D:o})}let $=L.graphData();function ut(c){return!{descendant:!0,next:!v.value}[c.kind]}function pt(c,h){let{nodes:g,links:f}=L.graphData();if(h?f.push(...$.links.filter(w=>w.kind===c)):f=f.filter(w=>w.kind!==c),c==="next"&&(f=f.filter(w=>w.kind!=="next"),h)){Lt(g);for(let w=1;w<g.length;w++){let u=g[w-1],x=g[w];f.push({source:u.id,target:x.id,kind:"next",color:"#006",isMain:!1})}}L.graphData({nodes:g,links:f})}m.watchImmediate(c=>pt("next",c)),b.watchImmediate(c=>pt("descendant",c)),v.watchImmediate(()=>{L.linkVisibility(ut)});function O(c){return typeof c=="string"?c:c.id}function Y(c,h){return O(c)===O(h)}function Q(c){return h=>Y(c,h)}return C.watchImmediate(c=>{c=c?.toLowerCase();let h=c?$.nodes.filter(u=>`${u.id} ${u.name} ${u.tags} ${u.created_at}`.toLowerCase().includes(c)):$.nodes,g=L.graphData(),f=[...h.map(u=>g.nodes.find(Q(u))??u),...c?$.nodes.filter(u=>h.some(x=>x.rootId===u.rootId&&x.id!==u.id)):[]].map(u=>g.nodes.find(x=>x.id===u.id)??u),w=$.links.filter(u=>f.some(Q(u.source))&&f.some(Q(u.target))).map(({source:u,target:x,...Gt})=>({source:O(u),target:O(x),...Gt})).map(u=>g.links.find(x=>Y(u.source,x.source)&&Y(u.target,x.target))??u);L.graphData({nodes:f,links:w}),c?L.nodeVal(u=>h.some(x=>x.id===u.id)?3:u.val):L.nodeVal("val")}),setTimeout(()=>{m.set(!1),b.set(!1)},2e3),z}var{graphData:Ot,in3D:At}=window.colonyData;ct(Ot,{in3D:At})})()}var Qt=["next","descendant"];var st={rawClips:X(),lastProcessedPage:-1,allPagesProcessed:!1,links:X(),allLinksBuilt:!1},G=class{constructor(e=st){this.state=e;this.loadState()}reset(){this.state=st,console.log("Colony reset. Run build() to start building it again.")}storage=new W("colony",st);stateLoaded=new F;async loadState(e=!1){if(e){let n=await gt();if(!n){console.log("No file selected, aborting.");return}this.state=JSON.parse(n)}else this.state=await this.storage.load();this.stateLoaded.resolve()}async saveState(e=!1){if(e){let n=JSON.stringify(this.state),s=new Blob([n],{type:"application/json"}),a=URL.createObjectURL(s),l=document.createElement("a");l.href=a,l.download="suno_colony.json",l.click(),URL.revokeObjectURL(a)}else await this.storage.save(this.state)}async build(){try{this.state.allPagesProcessed||await this.fetchClips(),this.state.allLinksBuilt||await this.buildLinks()}finally{await this.saveState()}}async fetchClips(){for(console.log("Fetching liked clips...");;){await tt(1e3);let{data:{clips:e}}=await nt().root.apiClient.GET("/api/feed/v2",{params:{query:{is_liked:!0,page:this.state.lastProcessedPage+1}}});if(!e.length){this.state.allPagesProcessed=!0;break}this.state.rawClips.push(...e),this.state.lastProcessedPage++,console.log(`Processed page ${this.state.lastProcessedPage}; total clips: ${this.state.rawClips.length}`)}}rawClipsById={};async loadClip(e){await tt(1e3);console.log(`Clip ${e} not found in cache, loading...`);let n=await nt().root.clips.loadClipById(e)??Zt(e);return this.state.rawClips.push(n),n}getClipByIdSync(e){return this.rawClipsById[e]??=this.state.rawClips.find(n=>Xt(e)?n.audio_url.includes(e):n.id===e)}async getClipById(e){return e.startsWith("m_")&&(e=e.slice(2)),this.getClipByIdSync(e)??await this.loadClip(e)}async buildLinks(){console.log("Building links...");for(let e=0;e<this.state.rawClips.length;e++){let n=this.state.rawClips[e];e%100===0&&console.log(`Processed ${e} clips out of ${this.state.rawClips.length}`);let{metadata:s}=n,[a,l]="history"in s?mt(s.history[0],p=>typeof p=="string"?[p,"extend"]:p.infill?[p.id,"inpaint"]:[p.id,"extend"]):"concat_history"in s?[s.concat_history[1].id,"apply"]:"cover_clip_id"in s?[s.cover_clip_id,"cover"]:"upsample_clip_id"in s?[s.upsample_clip_id,"remaster"]:"type"in s&&s.type==="edit_crop"?await kt(n,this.state.rawClips).then(p=>p?[p,"crop"]:[void 0,void 0]):[void 0,void 0];a&&this.state.links.push([(await this.getClipById(a)).id,n.id,l])}this.state.allLinksBuilt=!0,console.log(`Built ${this.state.links.length} links.`),console.log("Colony built. Run `await vovas.colony.render()` to view it!")}_linkedClips;get linkedClips(){return this._linkedClips??=this.getLinkedClips()}getLinkedClips(){let e=this.state.links.reduce((s,[a,l,p])=>{let y=A(s,{id:a})??D(`Could not find parent for link ${a} -> ${l}.`),T=A(s,{id:l})??D(`Could not find child for link ${a} -> ${l}.`);if(T.parent)throw new Error(`Child ${l} already has a parent: ${T.parent.clip.id}`);return T.parent={kind:p,clip:y},(y.children??=[]).push({kind:p,clip:T}),s},yt(this.state.rawClips));for(let s of e.filter(({parent:a})=>!a))n(s,s);return e;function n(s,a){Object.assign(s,{root:a});for(let{clip:l}of s.children??[])n(l,a)}}_rootClips;get rootClips(){return this._rootClips??=this.getRootClips()}getRootClips(){let e=this.linkedClips.filter(({parent:n})=>!n);return et(e)}get sortedClips(){let e=[],{rootClips:n}=this;for(let a of n)s(a);return e.reverse();function s(a){e.push(a);let{children:l}=a;if(l)for(let{clip:p}of et(l,({clip:y})=>y.created_at))s(p)}}get syntheticLinks(){let e=[],{rootClips:n}=this,s=n[0];for(let a of this.linkedClips.filter(({children:l})=>l?.length))e.push([(a.root??D(`Clip ${a.id} has no root.`)).id,a.id,"descendant"]);return e}getTotalDescendants(e){let n=A(this.linkedClips,{id:e})??D(`Clip ${e} not found.`);return n.totalDescendants??=1+(n.children?.reduce((s,{clip:{id:a}})=>s+this.getTotalDescendants(a),0)??0)}get graphData(){let e=this.sortedClips.map(({id:a,title:l,metadata:{tags:p},created_at:y,children:T,audio_url:_,image_url:S,root:R})=>({id:a,name:l||p||y||a,created_at:y,audio_url:_,image_url:S,tags:p,rootId:R?.id,val:a===R?.id&&T?.length?2:T?.length?1:.5})),n=([a,l,p])=>({source:a,target:l,kind:p,color:p==="next"?"#006":void 0,isMain:!Qt.includes(p)&&this.getTotalDescendants(l)>1});return{nodes:e,links:[...this.syntheticLinks,...this.state.links].map(n)}}getHtml(e){return console.log("Rendering your colony, give it a few seconds..."),`<script>window.colonyData=${JSON.stringify({graphData:this.graphData,in3D:xt(e)})}<\/script><script>(${ot.toString()})()<\/script>`}renderedElement=void 0;async render(...[e]){console.log("Rendering your colony, give it a few seconds...");Z(window,{colonyData:{graphData:this.graphData,in3D:xt(e)}}),ot();}clear(){this.renderedElement?.remove()}renderToFile(...e){let n=this.getHtml(...e),s=new Blob([n],{type:"text/html"}),a=URL.createObjectURL(s),l=document.createElement("a");l.href=a,l.download="suno_colony.html",l.click(),URL.revokeObjectURL(a)}},V=new G;V.stateLoaded.promise.then(()=>{console.log("Welcome to Vova\u2019s Suno Colony! This is a nifty tool to visualize your liked clips and the relationships between them, such as extensions, inpaints, covers, etc., in a graph format. It takes a bit of time and hacks to build, but hopefully it\u2019ll be worth it!");let{state:{allPagesProcessed:i,allLinksBuilt:e}}=V;if(!i||!e)console.log("Run `await vovas.colony.build()` to start or continue building your colony!");else return console.log("Your colony is built, rendering!"),V.render()});function xt(i){return i?.toLowerCase()==="3d"}function Xt(i){return i.match(/_\d+$/)}function Zt(i){return console.warn(`Clip ${i} not found, creating a missing clip.`),{isMissing:!0,id:i,title:"*Clip not found*",created_at:null,audio_url:`https://cdn1.suno.ai/${i}.mp3`,image_url:"",metadata:{duration:0,tags:""}}}Z(window,{vovas:{Colony:G,colony:V}});})();
