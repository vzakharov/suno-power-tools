(vovas = { main() {
(()=>{function D(n,e){return n.find(Ve(e))}function Ve(n){return function(e){return Object.entries(n).every(([t,o])=>e[t]===o)}}var He=0;function ue(n=""){return`${n}${++He}`}function S(n,e){return Object.fromEntries(Object.entries(n).map(([t,o])=>[t,e(o,t)]))}function _(n,e){return S(n,e)}function z(n){return typeof n=="function"}function fe(n){return n}function me(n,e){return Object.assign(n,e)}function he(n){return n.filter(Boolean)}function q(){return[]}function R(n,e){return e(n)}function P(n){return JSON.parse(JSON.stringify(n))}function ye(n,e){Object.assign(n,e)}var ge=0;function Y(n){let e=Math.max(0,n-(Date.now()-ge));return new Promise(t=>{setTimeout(()=>{ge=Date.now(),t()},e)})}function g(n){throw new Error(n)}async function be(){let n=document.createElement("input");return n.type="file",n.click(),new Promise(e=>{n.onchange=()=>{let t=n.files?.[0];if(!t)return e(void 0);let o=new FileReader;o.onload=()=>{e(o.result),n.remove()},o.readAsText(t)}})}function Te(n){return n?new Date(n).getTime():0}function N(n,e=t=>t.created_at){return n.sort((t,o)=>Te(e(t))-Te(e(o)))}function xe(){debugger}function we(n,e){return e(n),n}async function ke(n,e){for(let t of e.slice(e.findIndex(o=>o.id===n.id)+1))if(t!==n&&t.metadata.tags===n.metadata.tags&&await ze(t.image_url,n.image_url))return console.warn(`Found potential base clip for cropped clip ${n.id}: ${t.id} (this is not guaranteed to be correct)`),t.id;console.warn(`Could not find a base clip for cropped clip ${n.id}, the clip will be mistakenly marked as a root clip.`)}async function ve(n){let t=await(await fetch(n)).blob();return new Promise((o,r)=>{let i=new Image;i.onload=()=>{URL.revokeObjectURL(i.src),o(i)},i.onerror=r,i.src=URL.createObjectURL(t)})}async function ze(n,e){let t=await ve(n),o=await ve(e),r=document.createElement("canvas");r.width=t.width,r.height=t.height;let i=r.getContext("2d")??g("Canvas 2D context not supported");i.drawImage(t,0,0);let s=i.getImageData(0,0,t.width,t.height);i.drawImage(o,0,0);let d=i.getImageData(0,0,o.width,o.height),u=s.data,m=d.data,h=u.length,x=0;for(let v=0;v<h;v+=4)for(let k=0;k<3;k++)x+=Math.abs(u[v+k]-m[v+k]);let C=x/(h/4);return r.remove(),C<32;}var F=class{resolve;reject;promise;constructor(){this.promise=new Promise((e,t)=>Object.assign(this,{resolve:e,reject:t}))}};var qe="vovas",L="sunoTools",Ye=new Promise((n,e)=>{let t=indexedDB.open(qe,1);t.onupgradeneeded=()=>t.result.createObjectStore(L),t.onsuccess=()=>n(t.result),t.onerror=()=>e(t.error)});async function J(n){return(await Ye).transaction(L,n)}function Re(n){return new Promise((e,t)=>{n.oncomplete=()=>e(),n.onerror=()=>t(n.error)})}async function Je(n){return(await J(n)).objectStore(L)}var $=class{constructor(e,t){this.key=e;this.init=t}async load(){let e=(await Je("readonly")).get(this.key);return new Promise((t,o)=>{e.onsuccess=()=>t(e.result??this.init),e.onerror=()=>o(e.error)})}async save(e){let t=await J("readwrite");return t.objectStore(L).put(e,this.key),Re(t)}async clear(){let e=await J("readwrite");return e.objectStore(L).delete(this.key),Re(e)}};var A=class extends Error{constructor(e){super(`smork: ${e}`)}};function b(n,e){return z(n)?Qe(n,e):new I(n)}var T=class{constructor(e){this._value=e}watchers=new Set;activeWatchers=new WeakSet;get(){return B?.(this),this._value}_set(e){let{_value:t}=this;if(e!==this._value){this._value=e;try{for(let o of this.watchers){if(this.activeWatchers.has(o)){console.warn("smork: watcher is already active \u2014 perhaps a circular dependency \u2014 exiting watch to prevent infinite loop");return}this.activeWatchers.add(o),o(e,t)}}finally{this.activeWatchers=new WeakSet}}}runAndWatch(e){e(this._value,this._value),this.watch(e)}watchImmediate=this.runAndWatch;watch(e){this.watchers.add(e)}onChange=this.watch;unwatch(e){this.watchers.delete(e)}get value(){return this.get()}map(e){let t=new U(this,e);return z(t.value)?(this.unwatch(t.update),(...o)=>new U(this,r=>e(r)(...o))):t}mapDefined(e){return this.map(t=>t!==void 0?e(t):void 0)}uses(e){return me(this,S(e,this.map))}setter(e=t=>this._set(t)){return new X(this,e)}},U=class extends T{constructor(t,o){super(o(t.value));this.source=t;this.mapper=o;t.watch(this.update)}update=t=>this._set(this.mapper(t))},I=class extends T{set(e){this._set(e)}set value(e){this.set(e)}get value(){return this.get()}bridge(e,t){return this.map(e).setter(o=>this.set(t(o)))}clone(){return new Q(this)}},Q=class extends U{constructor(t){super(t,fe);this.source=t}},X=class extends I{constructor(t,o,r=!1){super(t.value);this.source=t;this.allowMismatch=r;super.watch(ee(this))}set(t){if(super.set(t),!this.allowMismatch&&this.value!==t)throw new A("Setter did not update the value. If you want to allow this, set the allowMismatch property to true.")}};function ee(n){return e=>{n.set(e)}}var B,Z=class extends T{constructor(t){super(void 0);this.getter=t;this.track()}_dependencies=new Set;track=()=>{if(B)throw new A("Tried to compute a ref while another one is already being computed \u2014 did you nest a computed ref in another ref's getter function?");this._dependencies.forEach(t=>t.unwatch(this.track)),this._dependencies=new Set;try{B=t=>{t.watch(this.track),this._dependencies.add(t)},this._set(this.getter())}finally{B=void 0}};get dependencies(){return this._dependencies}};function Qe(n,e){return R(new Z(n),t=>e?t.setter(e):t)}function te(n){return n instanceof T?n.value:n}function ne(n){return n instanceof T?n:new T(n)}function Xe(n){return S(n,te)}function Ze(n){return S(n,ne)}function y(n,e=!1){let t=new I(Xe(n)),o=Ze(n);_(o,(i,s)=>{if(s in t)throw new A(`Key "${s}" already exists in the joint ref. Please use a different key.`);i.watch(d=>{let{[s]:u,...m}=t.value;t.value={...m,[s]:d}})});let r=t.clone();return e?[r,o]:r}var Ce=["a","abbr","address","area","article","aside","audio","b","base","bdi","bdo","blockquote","body","br","button","canvas","caption","cite","code","col","colgroup","data","datalist","dd","del","details","dfn","dialog","div","dl","dt","em","embed","fieldset","figcaption","figure","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","iframe","img","input","ins","kbd","label","legend","li","link","main","map","mark","menu","meta","meter","nav","noscript","object","ol","optgroup","option","output","p","picture","pre","progress","q","rp","rt","ruby","s","samp","script","search","section","select","slot","small","source","span","strong","style","sub","summary","sup","table","tbody","td","template","textarea","tfoot","th","thead","time","title","tr","track","u","ul","var","video","wbr"];function oe(n){function e(o,r){let[i,s]=Array.isArray(o)?[void 0,o]:[o,r];return t(i,s)}return e;function t(o,r){let i=document.createElement(n);return o&&_(o,(s,d)=>{typeof s=="function"?i[d]=s:R(s,u=>{m(te(u)),ne(u).watch(m);function m(h){typeof h=="boolean"?h?i.setAttribute(d,""):i.removeAttribute(d):i.setAttribute(d,String(h))}})}),r&&r.forEach(s=>{let d=void 0,u=m=>{let h=typeof m=="string"?document.createTextNode(m):m instanceof HTMLElement?m:document.createComment("");d?d.replaceWith(h):i.appendChild(h),d=h};s instanceof T?s.watchImmediate(u):u(s)}),i}}var{a:Ne,abbr:Dt,address:_t,area:Pt,article:Ft,aside:$t,audio:Le,b:Bt,base:jt,bdi:Mt,bdo:Ot,blockquote:Wt,body:Gt,br:Vt,button:E,canvas:Ht,caption:zt,cite:qt,code:Yt,col:Jt,colgroup:Qt,data:Xt,datalist:Zt,dd:en,del:tn,details:nn,dfn:on,dialog:rn,div:f,dl:an,dt:sn,em:ln,embed:cn,fieldset:dn,figcaption:pn,figure:un,footer:fn,form:mn,h1:hn,h2:gn,h3:Ae,h4:Tn,h5:yn,h6:bn,head:xn,header:wn,hgroup:vn,hr:kn,html:Rn,i:Cn,iframe:Sn,img:Ue,input:Nn,ins:Ln,kbd:An,label:et,legend:Un,li:In,link:En,main:Kn,map:Dn,mark:_n,menu:Pn,meta:Fn,meter:$n,nav:Bn,noscript:jn,object:Mn,ol:On,optgroup:Wn,option:Gn,output:Vn,p:Ie,picture:Hn,pre:zn,progress:qn,q:Yn,rp:Jn,rt:Qn,ruby:Xn,s:Zn,samp:eo,script:to,search:no,section:oo,select:ro,slot:io,small:ao,source:so,span:lo,strong:co,style:Ee,sub:po,summary:uo,sup:fo,table:mo,tbody:ho,td:go,template:To,textarea:yo,tfoot:bo,th:xo,thead:wo,time:vo,title:ko,tr:Ro,track:Co,u:So,ul:No,var:Lo,video:Ao,wbr:Uo}=Ce.reduce((n,e)=>(n[e]=oe(e),n),{});function j(n,e){return oe("input")({...e,type:"checkbox",checked:n,onchange:()=>n.set(!n.value)})}function Ke(n,e){return oe("input")({...e,type:"text",value:n,onkeyup:({key:t,target:o})=>{t==="Enter"&&o instanceof HTMLInputElement&&n.set(o.value)}})}function M(n,e){e.id||=ue("smork-input-");let t=[et({for:e.id},[n]),e];return e.type==="checkbox"&&t.reverse(),t}async function De(n,e,t){let o=n.document.createElement("script");return o.type="text/javascript",o.src=t,n.document.head.appendChild(o),new Promise(r=>{o.onload=()=>{r(n[e])}})}function O(n,e,t=void 0){return n.map(o=>o?e:t)}function re({id:n,image_url:e,name:t,tags:o}){return f({class:"relative"},[Ne({href:`https://suno.com/song/${n}`,target:"_blank"},[Ue({src:e,style:"opacity: 0.5; width: 200px"}),f({class:"absolute topleft",style:"width: 190px; padding: 5px"},[f([t||"[Untitled]"]),f({class:"smol"},[o||"(no style)"])])])])}var _e='.colony { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;}.colony button {background-color: #444;color: #eee}.colony #sidebar {position: fixed;padding: 10px;top: 0;left: 0;bottom: 0;width: 200px;background-color: #333;color: #eee;display: flex;flex-direction: column;justify-content: space-between;}.colony .f-row {display: flex;flex-direction: row;}.colony .f-col {display: flex;flex-direction: column;}.colony .smol {font-size: 0.8em;color: #aaa;}.colony .relative {position: relative;}.colony .absolute {position: absolute;}.colony .topleft {top: 0;left: 0;}.colony .p-1 {padding: 1rem;};.colony .p-2 {padding: 2rem;}.colony .w-100 {width: 100%;}.colony .h-100 {height: 100%;}.colony .j-between {justify-content: space-between;}.colony .settings > * {margin-top: 5px;}';async function ie(n,e,{mode:t=void 0}){let o=t?.toLowerCase()==="3d",r=b(!1),i=r.map(a=>!a),s=b(),d=b(!0),u=b(!0),m=b(""),h=b(!1),x=b(),C=b();C.onChange(()=>setTimeout(()=>{x.value?.play()},0));let v=new Map;function k(a){return v.get(a)??we(le.value?.nodes.find(l=>l.id===a)??g(`Node with ID ${a} not found.`),l=>v.set(a,l))}let Fe=await De(window,"ForceGraph",`https://unpkg.com/${o?"3d-":""}force-graph`);window.document.head.appendChild(Ee([_e]));let $e=P(e);let w=s.mapDefined(a=>{let l=new Fe(a).graphData($e).backgroundColor("#001").linkAutoColorBy("kind").nodeAutoColorBy("rootId").linkLabel("kind").linkDirectionalParticles(1).nodeLabel(c=>f([re(c),f({class:"smol"},["Click to play, right-click to open in Suno"])]).outerHTML).onNodeClick(ee(C)).onNodeRightClick(({id:c})=>{window.open(`https://suno.com/song/${c}`)});return o?l.linkOpacity(c=>c.isMain?1:.2):l.linkLineDash(c=>c.isMain?null:[1,2]),l}),le=w.map(a=>a?.graphData());async function Be(){new FinalizationRegistry(()=>console.log("Previous graph destroyed, container removed from memory")).register(w,""),w.value?._destructor(),Ge.remove(),await ie(this,e,{mode:t})}y({graph:w,showNextLinks:h}).map(({graph:a,showNextLinks:l})=>{a?.linkVisibility(c=>!{descendant:!0,next:!l}[c.kind])});function ce(a){return typeof a=="string"?a:a.id}function V(a,l){return ce(a)===ce(l)}function je(a){return l=>V(a,l)}let H=y({data:le,graph:w}).map(({data:a,graph:l})=>{let c=l?.graphData();return c?a&&{nodes:a.nodes.map(p=>c.nodes.find(je(p))??p),links:a.links.map(p=>c.links.find(pe=>V(p.source,pe.source)&&V(p.target,pe.target))??p)}:a}),de=y({reusableData:H,filterString:m,graph:w}).map(({reusableData:{nodes:a}={},filterString:l,graph:c})=>!a||!c?[]:l?(l=l.toLowerCase(),a.filter(p=>`${p.id} ${p.name} ${p.tags} ${p.created_at}`.toLowerCase().includes(l))):a);y({graph:w,matchingNodes:de}).map(({graph:a,matchingNodes:l})=>a?.nodeVal(c=>l.some(p=>p.id===c.id)?3:c.val));let K=y({matchingNodes:de,reusableData:H}).map(({matchingNodes:a,reusableData:{nodes:l}={}})=>[...a,...l?.filter(c=>a.some(p=>p.rootId===c.rootId&&p.id!==c.id))??[]]),Me=y({nodes:K,useNextLinks:d}).map(({nodes:a,useNextLinks:l})=>!a||!l?[]:(N(a),a.slice(1).map((c,p)=>({source:a[p].id,target:c.id,kind:"next",color:"#006",isMain:!1})))),Oe=y({nodes:K,useDescendantLinks:u}).map(({nodes:a,useDescendantLinks:l})=>!a||!l?[]:he(a.map(c=>{let p=k(c.rootId??g(`Node ${c.id} has no root ID.`));return p!==c?{source:p.id,target:c.id,kind:"descendant",isMain:!1}:null}))),We=y({reusableData:H,nodes:K,nextLinks:Me,descendantLinks:Oe}).map(({reusableData:{links:a}={},nodes:l,nextLinks:c,descendantLinks:p})=>!a||!l?[]:[...a,...c,...p]);y({graph:w,nodes:K,links:We}).map(({graph:a,...l})=>{a?.graphData(l)}),setTimeout(()=>{d.set(!1),u.set(!1)},2e3);let Ge=document.body.appendChild(f({class:"colony",style:"position: fixed; top: 0px; left: 0px; z-index: 100;"},[O(i,f({style:"flex-direction: column; height: 100vh; width: 100vh; background-color: #000;"},[s.value=f(),f({id:"sidebar"},[f({class:"settings f-col"},[E({style:"margin-bottom: 5px;",onclick:()=>r.set(!0)},["Close Colony"]),Ae(["Settings"]),f(M("Attract based on time",j(d))),O(d,f(M("Show time-based links",j(h)))),f(M("Attract to root clip",j(u))),f([Ke(m,{placeholder:"Filter by name, style or ID"}),Ie({class:"smol"},["Enter to apply. (Filter will include both matching nodes and any nodes belonging to the same root clip.)"])]),E({onclick:Be},["Redraw"]),E({onclick:()=>n.renderToFile(t)},["Download"])]),O(C,a=>f({class:"w-100"},[re(a),x.value=Le({src:a.audio_url,controls:!0,class:"w-100"})]))])]),E({style:"position: fixed; top: 0px; left: 0px; padding: 5px; z-index: 100;",onclick:()=>r.set(!1)},["Reopen Colony"]))]))}var tt="https://studio-api.prod.suno.com/api/";function Pe(n,e){return async(...t)=>{let o=n(...t),r=await fetch(tt+o,{headers:{authorization:`Bearer ${await window.Clerk.session.getToken()}`}});if(r.status===404&&e){console.warn(`Could not find resource at ${o}, returning undefined`);return}return await r.json()}}var ae={getClips:Pe(n=>"feed/v2?is_liked=true&page="+n),getClip:Pe(n=>"clip/"+n,!0)};var nt=["next","descendant"];var se={rawClips:q(),lastProcessedPage:-1,allPagesProcessed:!1,links:q(),allLinksBuilt:!1},G=class{constructor(e=se){this.state=e;this.loadState()}reset(){this.state=se,console.log("Colony reset. Run build() to start building it again.")}storage=new $("colony",se);stateLoaded=new F;async loadState(e=!1){if(e){let t=await be();if(!t){console.log("No file selected, aborting.");return}this.state=JSON.parse(t)}else this.state=await this.storage.load();this.stateLoaded.resolve()}async saveState(e=!1){if(e){let t=JSON.stringify(this.state),o=new Blob([t],{type:"application/json"}),r=URL.createObjectURL(o),i=document.createElement("a");i.href=r,i.download="suno_colony.json",i.click(),URL.revokeObjectURL(r)}else await this.storage.save(this.state)}async build(){try{this.state.allPagesProcessed||await this.fetchClips(),this.state.allLinksBuilt||await this.buildLinks()}finally{await this.saveState()}}async fetchClips(){for(console.log("Fetching liked clips...");;){await Y(1e3);let{clips:e}=await ae.getClips(this.state.lastProcessedPage+1);if(!e.length){this.state.allPagesProcessed=!0;break}this.state.rawClips.push(...e),this.state.lastProcessedPage++,console.log(`Processed page ${this.state.lastProcessedPage}; total clips: ${this.state.rawClips.length}`)}}rawClipsById={};async loadClip(e){await Y(1e3);console.log(`Clip ${e} not found in cache, loading...`);let t=await ae.getClip(e)??rt(e);return this.state.rawClips.push(t),t}getClipByIdSync(e){return this.rawClipsById[e]??=this.state.rawClips.find(t=>ot(e)?t.audio_url.includes(e):t.id===e)}async getClipById(e){return e.startsWith("m_")&&(e=e.slice(2)),this.getClipByIdSync(e)??await this.loadClip(e)}async buildLinks(){console.log("Building links...");for(let e=0;e<this.state.rawClips.length;e++){let t=this.state.rawClips[e];e%100===0&&console.log(`Processed ${e} clips out of ${this.state.rawClips.length}`);let{metadata:o}=t,[r,i]="history"in o?R(o.history[0],s=>typeof s=="string"?[s,"extend"]:s.infill?[s.id,"inpaint"]:[s.id,"extend"]):"concat_history"in o?[o.concat_history[1].id,"apply"]:"cover_clip_id"in o?[o.cover_clip_id,"cover"]:"upsample_clip_id"in o?[o.upsample_clip_id,"remaster"]:"type"in o&&o.type==="edit_crop"?await ke(t,this.state.rawClips).then(s=>s?[s,"crop"]:[void 0,void 0]):[void 0,void 0];r&&this.state.links.push([(await this.getClipById(r)).id,t.id,i])}this.state.allLinksBuilt=!0,console.log(`Built ${this.state.links.length} links.`),console.log("Colony built. Run `await vovas.colony.render()` to view it!")}_linkedClips;get linkedClips(){return this._linkedClips??=this.getLinkedClips()}getLinkedClips(){let e=this.state.links.reduce((o,[r,i,s])=>{let d=D(o,{id:r})??g(`Could not find parent for link ${r} -> ${i}.`),u=D(o,{id:i})??g(`Could not find child for link ${r} -> ${i}.`);if(u.parent)throw new Error(`Child ${i} already has a parent: ${u.parent.clip.id}`);return u.parent={kind:s,clip:d},(d.children??=[]).push({kind:s,clip:u}),o},P(this.state.rawClips));for(let o of e.filter(({parent:r})=>!r))t(o,o);return e;function t(o,r){Object.assign(o,{root:r});for(let{clip:i}of o.children??[])t(i,r)}}_rootClips;get rootClips(){return this._rootClips??=this.getRootClips()}getRootClips(){let e=this.linkedClips.filter(({parent:t})=>!t);return N(e)}get sortedClips(){let e=[],{rootClips:t}=this;for(let r of t)o(r);return e.reverse();function o(r){e.push(r);let{children:i}=r;if(i)for(let{clip:s}of N(i,({clip:d})=>d.created_at))o(s)}}get syntheticLinks(){let e=[],{rootClips:t}=this,o=t[0];for(let r of this.linkedClips.filter(({children:i})=>i?.length))e.push([(r.root??g(`Clip ${r.id} has no root.`)).id,r.id,"descendant"]);return e}getTotalDescendants(e){let t=D(this.linkedClips,{id:e})??g(`Clip ${e} not found.`);return t.totalDescendants??=1+(t.children?.reduce((o,{clip:{id:r}})=>o+this.getTotalDescendants(r),0)??0)}_graphData=void 0;getGraphData(){let e=this.sortedClips.map(({id:r,title:i,metadata:{tags:s},created_at:d,children:u,audio_url:m,image_url:h,root:x})=>({id:r,name:i||s||d||r,created_at:d,audio_url:m,image_url:h,tags:s,rootId:x?.id,val:r===x?.id&&u?.length?2:u?.length?1:.5})),t=([r,i,s])=>({source:r,target:i,kind:s,color:s==="next"?"#006":void 0,isMain:!nt.includes(s)&&this.getTotalDescendants(i)>1});return{nodes:e,links:[...this.syntheticLinks,...this.state.links].map(t)}}get graphData(){return this._graphData??=this.getGraphData()}getHtml(e){return console.log("Rendering your colony, give it a few seconds..."),`<script>(vovas = {${window.vovas.main.toString()}}).main();vovas.colony.render(...${JSON.stringify([e,this.graphData])})<\/script>`}async render(e,t){console.log("Rendering your colony, give it a few seconds..."),this._graphData??=t,await ie(this,this.graphData,{mode:e})}renderToFile(...e){let t=this.getHtml(...e),o=new Blob([t],{type:"text/html"}),r=URL.createObjectURL(o),i=document.createElement("a");i.href=r,i.download="suno_colony.html",i.click(),URL.revokeObjectURL(r)}},W=new G;W.stateLoaded.promise.then(async()=>{console.log("Welcome to Vova\u2019s Suno Colony! This is a nifty tool to visualize your liked clips and the relationships between them, such as extensions, inpaints, covers, etc., in a graph format. It takes a bit of time and hacks to build, but hopefully it\u2019ll be worth it!");let{state:{allPagesProcessed:n,allLinksBuilt:e}}=W;!n||!e?console.log("Run `await vovas.colony.build()` to start or continue building your colony!"):(console.log("Your colony is built, rendering!"),await W.render())});function ot(n){return n.match(/_\d+$/)}function rt(n){return console.warn(`Clip ${n} not found, creating a missing clip.`),{isMissing:!0,id:n,title:"*Clip not found*",created_at:null,audio_url:`https://cdn1.suno.ai/${n}.mp3`,image_url:"",metadata:{duration:0,tags:""}}}ye(window.vovas,{Colony:G,colony:W,debug:xe});})();
}}).main();
