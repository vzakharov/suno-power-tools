(vovas = { main() {
(()=>{function I(t,e){return t.find(ze(e))}function ze(t){return function(e){return Object.entries(t).every(([n,o])=>e[n]===o)}}var pe={};function ue(t=""){return pe[t]??=0,`${t}${++pe[t]}`}function E(t,e){return Object.fromEntries(Object.entries(t).map(([n,o])=>[n,e(o,n)]))}function U(t,e){return E(t,e)}function z(t){return typeof t=="function"}function fe(t){return t}function me(t,e){return Object.assign(t,e)}function he(t){return t.filter(Boolean)}function q(){return[]}function v(t,e){return e(t)}function D(t){return JSON.parse(JSON.stringify(t))}function Te(t,e){Object.assign(t,e)}var ye=0;function Y(t){let e=Math.max(0,t-(Date.now()-ye));return new Promise(n=>{setTimeout(()=>{ye=Date.now(),n()},e)})}function T(t){throw new Error(t)}async function be(){let t=document.createElement("input");return t.type="file",t.click(),new Promise(e=>{t.onchange=()=>{let n=t.files?.[0];if(!n)return e(void 0);let o=new FileReader;o.onload=()=>{e(o.result),t.remove()},o.readAsText(n)}})}function ge(t){return t?new Date(t).getTime():0}function C(t,e=n=>n.created_at){return t.sort((n,o)=>ge(e(n))-ge(e(o)))}function xe(){debugger}function we(t,e){return e(t),t}function ke(){return new Promise(t=>{setTimeout(t,0)})}async function Re(t,e){for(let n of e.slice(e.findIndex(o=>o.id===t.id)+1))if(n!==t&&n.metadata.tags===t.metadata.tags&&await qe(n.image_url,t.image_url))return console.warn(`Found potential base clip for cropped clip ${t.id}: ${n.id} (this is not guaranteed to be correct)`),n.id;console.warn(`Could not find a base clip for cropped clip ${t.id}, the clip will be mistakenly marked as a root clip.`)}async function ve(t){let n=await(await fetch(t)).blob();return new Promise((o,r)=>{let a=new Image;a.onload=()=>{URL.revokeObjectURL(a.src),o(a)},a.onerror=r,a.src=URL.createObjectURL(n)})}async function qe(t,e){let n=await ve(t),o=await ve(e),r=document.createElement("canvas");r.width=n.width,r.height=n.height;let a=r.getContext("2d")??T("Canvas 2D context not supported");a.drawImage(n,0,0);let s=a.getImageData(0,0,n.width,n.height);a.drawImage(o,0,0);let d=a.getImageData(0,0,o.width,o.height),u=s.data,y=d.data,h=u.length,b=0;for(let w=0;w<h;w+=4)for(let k=0;k<3;k++)b+=Math.abs(u[w+k]-y[w+k]);let R=b/(h/4);return r.remove(),R<32;}var K=class{resolve;reject;promise;constructor(){this.promise=new Promise((e,n)=>Object.assign(this,{resolve:e,reject:n}))}};var Ye="vovas",S="sunoTools",Je=new Promise((t,e)=>{let n=indexedDB.open(Ye,1);n.onupgradeneeded=()=>n.result.createObjectStore(S),n.onsuccess=()=>t(n.result),n.onerror=()=>e(n.error)});async function J(t){return(await Je).transaction(S,t)}function Ce(t){return new Promise((e,n)=>{t.oncomplete=()=>e(),t.onerror=()=>n(t.error)})}async function Qe(t){return(await J(t)).objectStore(S)}var _=class{constructor(e,n){this.key=e;this.init=n}async load(){let e=(await Qe("readonly")).get(this.key);return new Promise((n,o)=>{e.onsuccess=()=>n(e.result??this.init),e.onerror=()=>o(e.error)})}async save(e){let n=await J("readwrite");return n.objectStore(S).put(e,this.key),Ce(n)}async clear(){let e=await J("readwrite");return e.objectStore(S).delete(this.key),Ce(e)}};var F=class extends Error{constructor(e){super(`smork: ${e}`)}};function Xe(t){return t&&typeof t=="object"&&U(t,e=>e instanceof g)}function f(t,e){return z(t)?Ze(t,e):Xe(t)?new $(()=>E(t,te),{dontRetrack:!0}):new B(t)}var Q=new Set,g=class{constructor(e){this._value=e}watchers=new Set;activeWatchers=new WeakSet;effects=new Set;get(){return P?.(this),this._value}_set(e){let{_value:n}=this;if(e!==this._value){this._value=e;try{for(let o of this.watchers){if(this.activeWatchers.has(o)){console.warn("smork: watcher is already active \u2014 perhaps a circular dependency \u2014 exiting watch to prevent infinite loop");return}this.activeWatchers.add(o),o(e,n)}}finally{this.activeWatchers=new WeakSet}this.effects.forEach(async o=>{if(!Q.has(o)){Q.add(o),await ke();try{o()}finally{Q.delete(o)}}})}}runAndWatch(e){e(this._value,this._value),this.watch(e)}watchImmediate=this.runAndWatch;watch(e){this.watchers.add(e)}addEffect(e){this.effects.add(e)}onChange=this.watch;unwatch(e){this.watchers.delete(e)}get value(){return this.get()}map(e){let n=new L(this,e);return z(n.value)?(this.unwatch(n.update),(...o)=>new L(this,r=>e(r)(...o))):n}mapDefined(e){return this.map(n=>n!==void 0?e(n):void 0)}uses(e){return me(this,E(e,this.map))}setter(e=n=>this._set(n)){return new Z(this,e)}},L=class extends g{constructor(n,o){super(o(n.value));this.source=n;this.mapper=o;n.watch(this.update)}update=n=>this._set(this.mapper(n))},B=class extends g{set(e){this._set(e)}set value(e){this.set(e)}get value(){return this.get()}bridge(e,n){return this.map(e).setter(o=>this.set(n(o)))}clone(){return new X(this)}},X=class extends L{constructor(n){super(n,fe);this.source=n}},Z=class extends B{constructor(n,o,r=!1){super(n.value);this.source=n;this.allowMismatch=r;super.watch(ee(this))}set(n){if(super.set(n),!this.allowMismatch&&this.value!==n)throw new F("Setter did not update the value. If you want to allow this, set the allowMismatch property to true.")}};function ee(t){return e=>{t.set(e)}}var P,$=class extends g{constructor(n,o={}){super(void 0);this.getter=n;this.options=o;this.track()}_dependencies=new Set;track=()=>{if(P)throw new F("Tried to compute a ref while another one is already being computed \u2014 did you nest a computed ref in another ref's getter function?");this._dependencies.forEach(n=>n.unwatch(this.track)),this._dependencies=new Set;try{P=n=>{n.addEffect(this.options.dontRetrack?this.update:this.track),this._dependencies.add(n)},this.update()}finally{P=void 0}};update=()=>{this._set(this.getter())};get dependencies(){return this._dependencies}};function Ze(t,e){return v(new $(t),n=>e?n.setter(e):n)}function te(t){return t instanceof g?t.value:t}function Se(t){return t instanceof g?t:new g(t)}var Le=["a","abbr","address","area","article","aside","audio","b","base","bdi","bdo","blockquote","body","br","button","canvas","caption","cite","code","col","colgroup","data","datalist","dd","del","details","dfn","dialog","div","dl","dt","em","embed","fieldset","figcaption","figure","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","iframe","img","input","ins","kbd","label","legend","li","link","main","map","mark","menu","meta","meter","nav","noscript","object","ol","optgroup","option","output","p","picture","pre","progress","q","rp","rt","ruby","s","samp","script","search","section","select","slot","small","source","span","strong","style","sub","summary","sup","table","tbody","td","template","textarea","tfoot","th","thead","time","title","tr","track","u","ul","var","video","wbr"];function ne(t){function e(o,r){let[a,s]=Array.isArray(o)?[void 0,o]:[o,r];return n(a,s)}return e;function n(o,r){let a=document.createElement(t);return o&&U(o,(s,d)=>{typeof s=="function"?a[d]=s:v(s,u=>{y(te(u)),Se(u).watch(y);function y(h){typeof h=="boolean"?h?a.setAttribute(d,""):a.removeAttribute(d):a.setAttribute(d,String(h))}})}),r&&r.forEach(s=>{let d=void 0,u=y=>{let h=typeof y=="string"?document.createTextNode(y):y instanceof HTMLElement?y:document.createComment("");d?d.replaceWith(h):a.appendChild(h),d=h};s instanceof g?s.watchImmediate(u):u(s)}),a}}var{a:Ae,abbr:_t,address:Pt,area:Ft,article:Bt,aside:$t,audio:Ie,b:Mt,base:jt,bdi:Ot,bdo:Wt,blockquote:Gt,body:Ht,br:Vt,button:N,canvas:zt,caption:qt,cite:Yt,code:Jt,col:Qt,colgroup:Xt,data:Zt,datalist:en,dd:tn,del:nn,details:on,dfn:rn,dialog:an,div:m,dl:sn,dt:ln,em:cn,embed:dn,fieldset:pn,figcaption:un,figure:fn,footer:mn,form:hn,h1:yn,h2:gn,h3:Ee,h4:Tn,h5:bn,h6:xn,head:wn,header:kn,hgroup:vn,hr:Rn,html:Cn,i:Sn,iframe:Ln,img:Ue,input:Nn,ins:An,kbd:In,label:et,legend:En,li:Un,link:Dn,main:Kn,map:_n,mark:Pn,menu:Fn,meta:Bn,meter:$n,nav:Mn,noscript:jn,object:On,ol:Wn,optgroup:Gn,option:Hn,output:Vn,p:De,picture:zn,pre:qn,progress:Yn,q:Jn,rp:Qn,rt:Xn,ruby:Zn,s:eo,samp:to,script:no,search:oo,section:ro,select:io,slot:ao,small:so,source:lo,span:co,strong:po,style:Ke,sub:uo,summary:fo,sup:mo,table:ho,tbody:yo,td:go,template:To,textarea:bo,tfoot:xo,th:wo,thead:ko,time:vo,title:Ro,tr:Co,track:So,u:Lo,ul:No,var:Ao,video:Io,wbr:Eo}=Le.reduce((t,e)=>(t[e]=ne(e),t),{});function M(t,e){return ne("input")({...e,type:"checkbox",checked:t,onchange:()=>t.set(!t.value)})}function _e(t,e){return ne("input")({...e,type:"text",value:t,onkeyup:({key:n,target:o})=>{n==="Enter"&&o instanceof HTMLInputElement&&t.set(o.value)}})}function j(t,e){e.id||=ue("smork-input-");let n=[et({for:e.id},[t]),e];return e.type==="checkbox"&&n.reverse(),n}async function Pe(t,e,n){let o=t.document.createElement("script");return o.type="text/javascript",o.src=n,t.document.head.appendChild(o),new Promise(r=>{o.onload=()=>{r(t[e])}})}function O(t,e,n=void 0){return t.map(o=>o?e:n)}function oe({id:t,image_url:e,name:n,tags:o}){return m({class:"relative"},[Ae({href:`https://suno.com/song/${t}`,target:"_blank"},[Ue({src:e,style:"opacity: 0.5; width: 200px"}),m({class:"absolute topleft",style:"width: 190px; padding: 5px"},[m([n||"[Untitled]"]),m({class:"smol"},[o||"(no style)"])])])])}var Fe='.colony { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;}.colony button {background-color: #444;color: #eee}.colony #sidebar {position: fixed;padding: 10px;top: 0;left: 0;bottom: 0;width: 200px;background-color: #333;color: #eee;display: flex;flex-direction: column;justify-content: space-between;}.colony .f-row {display: flex;flex-direction: row;}.colony .f-col {display: flex;flex-direction: column;}.colony .smol {font-size: 0.8em;color: #aaa;}.colony .relative {position: relative;}.colony .absolute {position: absolute;}.colony .topleft {top: 0;left: 0;}.colony .p-1 {padding: 1rem;};.colony .p-2 {padding: 2rem;}.colony .w-100 {width: 100%;}.colony .h-100 {height: 100%;}.colony .j-between {justify-content: space-between;}.colony .settings > * {margin-top: 5px;}';async function re(t,e,{mode:n=void 0}){let o=n?.toLowerCase()==="3d",r=f(!1),a=r.map(i=>!i),s=f(),d=f(!0),u=f(!0),y=f(""),h=f(!1),b=f(),R=f();R.onChange(()=>setTimeout(()=>{b.value?.play()},0));let w=new Map;function k(i){return w.get(i)??we(se.value?.nodes.find(l=>l.id===i)??T(`Node with ID ${i} not found.`),l=>w.set(i,l))}let $e=await Pe(window,"ForceGraph",`https://unpkg.com/${o?"3d-":""}force-graph`);window.document.head.appendChild(Ke([Fe]));let it=D(e);let x=s.mapDefined(i=>{let l=new $e(i).backgroundColor("#001").linkAutoColorBy("kind").nodeAutoColorBy("rootId").linkLabel("kind").linkDirectionalParticles(1).nodeLabel(c=>m([oe(c),m({class:"smol"},["Click to play, right-click to open in Suno"])]).outerHTML).onNodeClick(ee(R)).onNodeRightClick(({id:c})=>{window.open(`https://suno.com/song/${c}`)});return o?l.linkOpacity(c=>c.isMain?1:.2):l.linkLineDash(c=>c.isMain?null:[1,2]),Object.assign(window,{graph:l}),l}),se=x.map(i=>i?.graphData());async function Me(){new FinalizationRegistry(()=>console.log("Previous graph destroyed, container removed from memory")).register(x,""),x.value?._destructor(),Ve.remove(),await re(this,e,{mode:n})}f({graph:x,showNextLinks:h}).map(({graph:i,showNextLinks:l})=>{i?.linkVisibility(c=>!{descendant:!0,next:!l}[c.kind])});function le(i){return typeof i=="string"?i:i.id}function H(i,l){return le(i)===le(l)}function je(i){return l=>H(i,l)}let Oe=f(Date.now),V=f({data:se,graph:x}).map(({data:i,graph:l})=>{let c=l?.graphData();return c?i&&{nodes:i.nodes.map(p=>c.nodes.find(je(p))??p),links:i.links.map(p=>c.links.find(de=>H(p.source,de.source)&&H(p.target,de.target))??p)}:i}),ce=f({reusableData:V,filterString:y,graph:x}).map(({reusableData:{nodes:i}={},filterString:l,graph:c})=>!i||!c?[]:l?(l=l.toLowerCase(),i.filter(p=>`${p.id} ${p.name} ${p.tags} ${p.created_at}`.toLowerCase().includes(l))):i);f({graph:x,matchingNodes:ce}).map(({graph:i,matchingNodes:l})=>i?.nodeVal(c=>l.some(p=>p.id===c.id)?3:c.val));let A=f({matchingNodes:ce,reusableData:V}).map(({matchingNodes:i,reusableData:{nodes:l}={}})=>[...i,...l?.filter(c=>i.some(p=>p.rootId===c.rootId&&p.id!==c.id))??[]]),We=f({nodes:A,useNextLinks:d}).map(({nodes:i,useNextLinks:l})=>!i||!l?[]:(C(i),i.slice(1).map((c,p)=>({source:i[p].id,target:c.id,kind:"next",color:"#006",isMain:!1})))),Ge=f({nodes:A,useDescendantLinks:u}).map(({nodes:i,useDescendantLinks:l})=>!i||!l?[]:he(i.map(c=>{let p=k(c.rootId??T(`Node ${c.id} has no root ID.`));return p!==c?{source:p.id,target:c.id,kind:"descendant",isMain:!1}:null}))),He=f({reusableData:V,nodes:A,nextLinks:We,descendantLinks:Ge}).map(({reusableData:{links:i}={},nodes:l,nextLinks:c,descendantLinks:p})=>!i||!l?[]:[...i,...c,...p]);f({graph:x,nodes:A,links:He}).watchImmediate(({graph:i,...l})=>{i?.graphData(l),Oe.update()}),setTimeout(()=>{d.set(!1),u.set(!1)},2e3);let Ve=document.body.appendChild(m({class:"colony",style:"position: fixed; top: 0px; left: 0px; z-index: 100;"},[O(a,m({style:"flex-direction: column; height: 100vh; width: 100vh; background-color: #000;"},[s.value=m(),m({id:"sidebar"},[m({class:"settings f-col"},[N({style:"margin-bottom: 5px;",onclick:()=>r.set(!0)},["Close Colony"]),Ee(["Settings"]),m(j("Attract based on time",M(d))),O(d,m(j("Show time-based links",M(h)))),m(j("Attract to root clip",M(u))),m([_e(y,{placeholder:"Filter by name, style or ID"}),De({class:"smol"},["Enter to apply. (Filter will include both matching nodes and any nodes belonging to the same root clip.)"])]),N({onclick:Me},["Redraw"]),N({onclick:()=>t.renderToFile(n)},["Download"])]),O(R,i=>m({class:"w-100"},[oe(i),b.value=Ie({src:i.audio_url,controls:!0,class:"w-100"})]))])]),N({style:"position: fixed; top: 0px; left: 0px; padding: 5px; z-index: 100;",onclick:()=>r.set(!1)},["Reopen Colony"]))]))}var tt="https://studio-api.prod.suno.com/api/";function Be(t,e){return async(...n)=>{let o=t(...n),r=await fetch(tt+o,{headers:{authorization:`Bearer ${await window.Clerk.session.getToken()}`}});if(r.status===404&&e){console.warn(`Could not find resource at ${o}, returning undefined`);return}return await r.json()}}var ie={getClips:Be(t=>"feed/v2?is_liked=true&page="+t),getClip:Be(t=>"clip/"+t,!0)};var nt=["next","descendant"];var ae={rawClips:q(),lastProcessedPage:-1,allPagesProcessed:!1,links:q(),allLinksBuilt:!1},G=class{constructor(e=ae){this.state=e;this.loadState()}reset(){this.state=ae,console.log("Colony reset. Run build() to start building it again.")}storage=new _("colony",ae);stateLoaded=new K;async loadState(e=!1){if(e){let n=await be();if(!n){console.log("No file selected, aborting.");return}this.state=JSON.parse(n)}else this.state=await this.storage.load();this.stateLoaded.resolve()}async saveState(e=!1){if(e){let n=JSON.stringify(this.state),o=new Blob([n],{type:"application/json"}),r=URL.createObjectURL(o),a=document.createElement("a");a.href=r,a.download="suno_colony.json",a.click(),URL.revokeObjectURL(r)}else await this.storage.save(this.state)}async build(){try{this.state.allPagesProcessed||await this.fetchClips(),this.state.allLinksBuilt||await this.buildLinks()}finally{await this.saveState()}}async fetchClips(){for(console.log("Fetching liked clips...");;){await Y(1e3);let{clips:e}=await ie.getClips(this.state.lastProcessedPage+1);if(!e.length){this.state.allPagesProcessed=!0;break}this.state.rawClips.push(...e),this.state.lastProcessedPage++,console.log(`Processed page ${this.state.lastProcessedPage}; total clips: ${this.state.rawClips.length}`)}}rawClipsById={};async loadClip(e){await Y(1e3);console.log(`Clip ${e} not found in cache, loading...`);let n=await ie.getClip(e)??rt(e);return this.state.rawClips.push(n),n}getClipByIdSync(e){return this.rawClipsById[e]??=this.state.rawClips.find(n=>ot(e)?n.audio_url.includes(e):n.id===e)}async getClipById(e){return e.startsWith("m_")&&(e=e.slice(2)),this.getClipByIdSync(e)??await this.loadClip(e)}async buildLinks(){console.log("Building links...");for(let e=0;e<this.state.rawClips.length;e++){let n=this.state.rawClips[e];e%100===0&&console.log(`Processed ${e} clips out of ${this.state.rawClips.length}`);let{metadata:o}=n,[r,a]="history"in o?v(o.history[0],s=>typeof s=="string"?[s,"extend"]:s.infill?[s.id,"inpaint"]:[s.id,"extend"]):"concat_history"in o?[o.concat_history[1].id,"apply"]:"cover_clip_id"in o?[o.cover_clip_id,"cover"]:"upsample_clip_id"in o?[o.upsample_clip_id,"remaster"]:"type"in o&&o.type==="edit_crop"?await Re(n,this.state.rawClips).then(s=>s?[s,"crop"]:[void 0,void 0]):[void 0,void 0];r&&this.state.links.push([(await this.getClipById(r)).id,n.id,a])}this.state.allLinksBuilt=!0,console.log(`Built ${this.state.links.length} links.`),console.log("Colony built. Run `await vovas.colony.render()` to view it!")}_linkedClips;get linkedClips(){return this._linkedClips??=this.getLinkedClips()}getLinkedClips(){let e=this.state.links.reduce((o,[r,a,s])=>{let d=I(o,{id:r})??T(`Could not find parent for link ${r} -> ${a}.`),u=I(o,{id:a})??T(`Could not find child for link ${r} -> ${a}.`);if(u.parent)throw new Error(`Child ${a} already has a parent: ${u.parent.clip.id}`);return u.parent={kind:s,clip:d},(d.children??=[]).push({kind:s,clip:u}),o},D(this.state.rawClips));for(let o of e.filter(({parent:r})=>!r))n(o,o);return e;function n(o,r){Object.assign(o,{root:r});for(let{clip:a}of o.children??[])n(a,r)}}_rootClips;get rootClips(){return this._rootClips??=this.getRootClips()}getRootClips(){let e=this.linkedClips.filter(({parent:n})=>!n);return C(e)}get sortedClips(){let e=[],{rootClips:n}=this;for(let r of n)o(r);return e.reverse();function o(r){e.push(r);let{children:a}=r;if(a)for(let{clip:s}of C(a,({clip:d})=>d.created_at))o(s)}}get syntheticLinks(){let e=[],{rootClips:n}=this,o=n[0];for(let r of this.linkedClips.filter(({children:a})=>a?.length))e.push([(r.root??T(`Clip ${r.id} has no root.`)).id,r.id,"descendant"]);return e}getTotalDescendants(e){let n=I(this.linkedClips,{id:e})??T(`Clip ${e} not found.`);return n.totalDescendants??=1+(n.children?.reduce((o,{clip:{id:r}})=>o+this.getTotalDescendants(r),0)??0)}_graphData=void 0;getGraphData(){let e=this.sortedClips.map(({id:r,title:a,metadata:{tags:s},created_at:d,children:u,audio_url:y,image_url:h,root:b})=>({id:r,name:a||s||d||r,created_at:d,audio_url:y,image_url:h,tags:s,rootId:b?.id,val:r===b?.id&&u?.length?2:u?.length?1:.5})),n=([r,a,s])=>({source:r,target:a,kind:s,color:s==="next"?"#006":void 0,isMain:!nt.includes(s)&&this.getTotalDescendants(a)>1});return{nodes:e,links:[...this.syntheticLinks,...this.state.links].map(n)}}get graphData(){return this._graphData??=this.getGraphData()}getHtml(e){return console.log("Rendering your colony, give it a few seconds..."),`<script>(vovas = {${window.vovas.main.toString()}}).main();vovas.colony.render(...${JSON.stringify([e,this.graphData])})<\/script>`}async render(e,n){console.log("Rendering your colony, give it a few seconds..."),this._graphData??=n,await re(this,this.graphData,{mode:e})}renderToFile(...e){let n=this.getHtml(...e),o=new Blob([n],{type:"text/html"}),r=URL.createObjectURL(o),a=document.createElement("a");a.href=r,a.download="suno_colony.html",a.click(),URL.revokeObjectURL(r)}},W=new G;W.stateLoaded.promise.then(async()=>{console.log("Welcome to Vova\u2019s Suno Colony! This is a nifty tool to visualize your liked clips and the relationships between them, such as extensions, inpaints, covers, etc., in a graph format. It takes a bit of time and hacks to build, but hopefully it\u2019ll be worth it!");let{state:{allPagesProcessed:t,allLinksBuilt:e}}=W;!t||!e?console.log("Run `await vovas.colony.build()` to start or continue building your colony!"):(console.log("Your colony is built, rendering!"),await W.render())});function ot(t){return t.match(/_\d+$/)}function rt(t){return console.warn(`Clip ${t} not found, creating a missing clip.`),{isMissing:!0,id:t,title:"*Clip not found*",created_at:null,audio_url:`https://cdn1.suno.ai/${t}.mp3`,image_url:"",metadata:{duration:0,tags:""}}}Te(window.vovas,{Colony:G,colony:W,debug:xe});})();
}}).main();
