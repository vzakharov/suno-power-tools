(vovas = { main() {
(()=>{function U(t,e){return t.find(Be(e))}function Be(t){return function(e){return Object.entries(t).every(([o,r])=>e[o]===r)}}var Oe=0;function le(t=""){return`${t}${++Oe}`}function J(t,e){return Object.fromEntries(Object.entries(t).map(([o,r])=>[o,e(r,o)]))}function se(t,e){return J(t,e)}function Q(t){return typeof t=="function"}function ce(t,e){return Object.assign(t,e)}function X(){return[]}function I(t,e){return e(t)}function K(t){return JSON.parse(JSON.stringify(t))}function fe(t,e){Object.assign(t,e)}var de=0;function Z(t){let e=Math.max(0,t-(Date.now()-de));return new Promise(o=>{setTimeout(()=>{de=Date.now(),o()},e)})}function E(t){throw new Error(t)}async function me(){let t=document.createElement("input");return t.type="file",t.click(),new Promise(e=>{t.onchange=()=>{let o=t.files?.[0];if(!o)return e(void 0);let r=new FileReader;r.onload=()=>{e(r.result),t.remove()},r.readAsText(o)}})}function ue(t){return t?new Date(t).getTime():0}function F(t,e=o=>o.created_at){return t.sort((o,r)=>ue(e(o))-ue(e(r)))}function ye(){debugger}async function he(t,e){for(let o of e.slice(e.findIndex(r=>r.id===t.id)+1))if(o!==t&&o.metadata.tags===t.metadata.tags&&await We(o.image_url,t.image_url))return console.warn(`Found potential base clip for cropped clip ${t.id}: ${o.id} (this is not guaranteed to be correct)`),o.id;console.warn(`Could not find a base clip for cropped clip ${t.id}, the clip will be mistakenly marked as a root clip.`)}async function Te(t){let o=await(await fetch(t)).blob();return new Promise((r,n)=>{let i=new Image;i.onload=()=>{URL.revokeObjectURL(i.src),r(i)},i.onerror=n,i.src=URL.createObjectURL(o)})}async function We(t,e){let o=await Te(t),r=await Te(e),n=document.createElement("canvas");n.width=o.width,n.height=o.height;let i=n.getContext("2d")??E("Canvas 2D context not supported");i.drawImage(o,0,0);let a=i.getImageData(0,0,o.width,o.height);i.drawImage(r,0,0);let p=i.getImageData(0,0,r.width,r.height),c=a.data,f=p.data,m=c.length,b=0;for(let S=0;S<m;S+=4)for(let N=0;N<3;N++)b+=Math.abs(c[S+N]-f[S+N]);let C=b/(m/4);return n.remove(),C<32;}var D=class{resolve;reject;promise;constructor(){this.promise=new Promise((e,o)=>Object.assign(this,{resolve:e,reject:o}))}};var qe="vovas",v="sunoTools",Ve=new Promise((t,e)=>{let o=indexedDB.open(qe,1);o.onupgradeneeded=()=>o.result.createObjectStore(v),o.onsuccess=()=>t(o.result),o.onerror=()=>e(o.error)});async function ee(t){return(await Ve).transaction(v,t)}function xe(t){return new Promise((e,o)=>{t.oncomplete=()=>e(),t.onerror=()=>o(t.error)})}async function Ge(t){return(await ee(t)).objectStore(v)}var _=class{constructor(e,o){this.key=e;this.init=o}async load(){let e=(await Ge("readonly")).get(this.key);return new Promise((o,r)=>{e.onsuccess=()=>o(e.result??this.init),e.onerror=()=>r(e.error)})}async save(e){let o=await ee("readwrite");return o.objectStore(v).put(e,this.key),xe(o)}async clear(){let e=await ee("readwrite");return e.objectStore(v).delete(this.key),xe(e)}};var M=class extends Error{constructor(e){super(`smork: ${e}`)}};function x(t,e){return Q(t)?be(t,e):new w(t)}var k=class{constructor(e){this._value=e}watchers=new Set;activeWatchers=new WeakSet;get(){return A?.(this),this._value}_set(e){let{_value:o}=this;if(e!==this._value){this._value=e;try{for(let r of this.watchers){if(this.activeWatchers.has(r)){console.warn("smork: watcher is already active \u2014 perhaps a circular dependency \u2014 exiting watch to prevent infinite loop");return}this.activeWatchers.add(r),r(e,o)}}finally{this.activeWatchers=new WeakSet}}}runAndWatch(e){e(this._value,this._value),this.watch(e)}watchImmediate=this.runAndWatch;watch(e){this.watchers.add(e)}onChange=this.watch;unwatch(e){this.watchers.delete(e)}get value(){return this.get()}map(e){let o=new $(this,e);return Q(o.value)?(this.unwatch(o.update),(...r)=>new $(this,n=>e(n)(...r))):o}merge(e){return e?be(()=>({...this.value,...te(e)})):this}uses(e){return ce(this,J(e,this.map))}onceDefined(e){let o=r=>{r&&(this.unwatch(o),e(r))};this.watchImmediate(o)}},$=class extends k{constructor(o,r){var e=(...st)=>(super(...st),this.dependency=o,this.mapper=r,this);o&&(e(r(o.value)),o.watch(this.update))}update=o=>this._set(this.mapper(o))},w=class extends k{set(e){this._set(e)}set value(e){this.set(e)}get value(){return this.get()}bridge(e,o){return new B(()=>e(this.value),r=>this.set(o(r)))}};function ge(t){return e=>{t.set(e)}}var A,j=class extends w{constructor(o){super(void 0);this.getter=o;this.track()}dependencies=new Set;track=()=>{if(A)throw new M("Tried to compute a ref while another one is already being computed \u2014 did you nest a computed ref in another ref's getter function?");this.dependencies.forEach(o=>o.unwatch(this.track)),this.dependencies=new Set;try{A=o=>{o.watch(this.track),this.dependencies.add(o)},this._set(this.getter())}finally{A=void 0}}},B=class extends w{constructor(o,r,n=!1){let i=new j(o);super(i.value);this.setter=r;this.allowMismatch=n;i.watch(a=>this._set(a))}set(o){if(this.setter(o),!this.allowMismatch&&this.value!==o)throw new M("Setter did not update the value. If you want to allow this, set the allowMismatch property to true.")}};function be(t,e){return e?new B(t,e):new j(t)}function te(t){return t instanceof k?t.value:t}function Re(t){return t instanceof k?t:new k(t)}function ke(...t){return g("a")(...t)}function Ne(...t){return g("audio")(...t)}function P(...t){return g("button")(...t)}function u(...t){return g("div")(...t)}function Se(...t){return g("h3")(...t)}function Ee(...t){return g("img")(...t)}function Fe(...t){return g("label")(...t)}function ve(...t){return g("p")(...t)}function we(...t){return g("style")(...t)}function g(t){function e(r,n){let[i,a]=Array.isArray(r)?[void 0,r]:[r,n];return o(i,a)}return e;function o(r,n){let i=document.createElement(t);return r&&se(r,(a,p)=>{typeof a=="function"?i[p==="style"?"cssText":p]=a():I(a,c=>{f(te(c)),Re(c).watch(f);function f(m){typeof m=="boolean"?m?i.setAttribute(p,""):i.removeAttribute(p):i.setAttribute(p,String(m))}})}),n&&n.forEach(a=>{let p=void 0,c=f=>{let m=typeof f=="string"?document.createTextNode(f):f instanceof HTMLElement?f:document.createComment("");p?p.replaceWith(m):i.appendChild(m),p=m};a instanceof k?a.watchImmediate(c):c(a)}),i}}var O=Le("input","checked",Boolean,{type:"checkbox"},t=>({onchange:()=>t.set(!t.value)})),Ce=Le("input","value",String,{type:"text"},t=>({onkeyup:({key:e,target:o})=>{e==="Enter"&&o instanceof HTMLInputElement&&t.set(o.value)}}));function Le(t,e,o,r){return(n,i)=>t(t)({...o,...i,[e]:n,...r(n)})}function W(t,e){e.id||=le("smork-input-");let o=[Fe({for:e.id},[t]),e];return e.type==="checkbox"&&o.reverse(),o}async function Ue(t,e,o){let r=t.document.createElement("script");return r.type="text/javascript",r.src=o,t.document.head.appendChild(r),new Promise(n=>{r.onload=()=>{n(t[e])}})}function q(t,e,o=void 0){return t.map(r=>r?e:o)}function oe({id:t,image_url:e,name:o,tags:r}){return u({class:"relative"},[ke({href:`https://suno.com/song/${t}`,target:"_blank"},[Ee({src:e,style:"opacity: 0.5; width: 200px"}),u({class:"absolute topleft",style:"width: 190px; padding: 5px"},[u([o||"[Untitled]"]),u({class:"smol"},[r||"(no style)"])])])])}var Ie='.colony { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;}.colony button {background-color: #444;color: #eee}.colony #sidebar {position: fixed;padding: 10px;top: 0;left: 0;bottom: 0;width: 200px;background-color: #333;color: #eee;display: flex;flex-direction: column;justify-content: space-between;}.colony .f-row {display: flex;flex-direction: row;}.colony .f-col {display: flex;flex-direction: column;}.colony .smol {font-size: 0.8em;color: #aaa;}.colony .relative {position: relative;}.colony .absolute {position: absolute;}.colony .topleft {top: 0;left: 0;}.colony .p-1 {padding: 1rem;};.colony .p-2 {padding: 2rem;}.colony .w-100 {width: 100%;}.colony .h-100 {height: 100%;}.colony .j-between {justify-content: space-between;}.colony .settings > * {margin-top: 5px;}';async function re(t,e,{mode:o=void 0}){let r=o?.toLowerCase()==="3d",n=x(!1),i=n.map(l=>!l),a=x();a.onceDefined(Ae);let p=x(),c=p.map(l=>l?.graphData()),f=x(!0),m=x(!1),b=x(!0),C=x(""),S=x(),N=x();N.onChange(()=>setTimeout(()=>{S.value?.play()},0));let De=await Ue(window,"ForceGraph",`https://unpkg.com/${r?"3d-":""}force-graph`);window.document.head.appendChild(we([Ie]));let _e=K(e);function Ae(l){p.value=new De(l).graphData(_e).backgroundColor("#001").linkAutoColorBy("kind").nodeAutoColorBy("rootId").linkLabel("kind").linkVisibility(ae).linkDirectionalParticles(1).nodeLabel(d=>u([oe(d),u({class:"smol"},["Click to play, right-click to open in Suno"])]).outerHTML).onNodeClick(ge(N)).onNodeRightClick(({id:d})=>{window.open(`https://suno.com/song/${d}`)}),r?p.value.linkOpacity(d=>d.isMain?1:.2):p.value.linkLineDash(d=>d.isMain?null:[1,2])}async function Me(){new FinalizationRegistry(()=>console.log("Previous graph destroyed, container removed from memory")).register(p,""),p.value?._destructor(),$e.remove(),await re(this,e,{mode:o})}function ae(l){return!{descendant:!0,next:!m.value}[l.kind]}function pe(l,d){if(!c.value||!p.value)return;let{nodes:R,links:T}=c.value;if(d?T.push(...c.value.links.filter(y=>y.kind===l)):T=T.filter(y=>y.kind!==l),l==="next"&&(T=T.filter(y=>y.kind!=="next"),d)){F(R);for(let y=1;y<R.length;y++){let z=R[y-1],s=R[y];T.push({source:z.id,target:s.id,kind:"next",color:"#006",isMain:!1})}}p.value.graphData({nodes:R,links:T})}f.watchImmediate(l=>pe("next",l)),b.watchImmediate(l=>pe("descendant",l)),m.watchImmediate(()=>{p.value?.linkVisibility(ae)});function L(l){return typeof l=="string"?l:l.id}function H(l,d){return L(l)===L(d)}function Y(l){return d=>H(l,d)}C.watchImmediate(l=>{if(!c.value||!p.value)return;let d=l?.toLowerCase(),R=d?c.value.nodes.filter(s=>`${s.id} ${s.name} ${s.tags} ${s.created_at}`.toLowerCase().includes(d)):c.value.nodes,T=p.value.graphData(),y=[...R.map(s=>T.nodes.find(Y(s))??s),...d?c.value.nodes.filter(s=>R.some(h=>h.rootId===s.rootId&&h.id!==s.id)):[]].map(s=>T.nodes.find(h=>h.id===s.id)??s),z=c.value.links.filter(s=>y.some(Y(s.source))&&y.some(Y(s.target))).map(({source:s,target:h,...je})=>({source:L(s),target:L(h),...je})).map(s=>T.links.find(h=>H(s.source,h.source)&&H(s.target,h.target))??s);p.value.graphData({nodes:y,links:z}),d?p.value.nodeVal(s=>R.some(h=>h.id===s.id)?3:s.val):p.value.nodeVal("val")}),setTimeout(()=>{f.set(!1),b.set(!1)},2e3);let $e=document.body.appendChild(u({class:"colony",style:"position: fixed; top: 0px; left: 0px; z-index: 100;"},[q(i,u({style:"flex-direction: column; height: 100vh; width: 100vh; background-color: #000;"},[a.value=u(),u({id:"sidebar"},[u({class:"settings f-col"},[P({style:"margin-bottom: 5px;",onclick:()=>n.set(!0)},["Close Colony"]),Se(["Settings"]),u(W("Attract based on time",O(f))),q(f,u(W("Show time-based links",O(m)))),u(W("Attract to root clip",O(b))),u([Ce(C,{placeholder:"Filter by name, style or ID"}),ve({class:"smol"},["Enter to apply. (Filter will include both matching nodes and any nodes belonging to the same root clip.)"])]),P({onclick:Me},["Redraw"]),P({onclick:()=>t.renderToFile(o)},["Download"])]),q(N,l=>u({class:"w-100"},[oe(l),S.value=Ne({src:l.audio_url,controls:!0,class:"w-100"})]))])]),P({style:"position: fixed; top: 0px; left: 0px; padding: 5px; z-index: 100;",onclick:()=>n.set(!1)},["Reopen Colony"]))]))}var He="https://studio-api.prod.suno.com/api/";function Ke(t,e){return async(...o)=>{let r=t(...o),n=await fetch(He+r,{headers:{authorization:`Bearer ${await window.Clerk.session.getToken()}`}});if(n.status===404&&e){console.warn(`Could not find resource at ${r}, returning undefined`);return}return await n.json()}}var ne={getClips:Ke(t=>"feed/v2?is_liked=true&page="+t),getClip:Ke(t=>"clip/"+t,!0)};var Ye=["next","descendant"];var ie={rawClips:X(),lastProcessedPage:-1,allPagesProcessed:!1,links:X(),allLinksBuilt:!1},G=class{constructor(e=ie){this.state=e;this.loadState()}reset(){this.state=ie,console.log("Colony reset. Run build() to start building it again.")}storage=new _("colony",ie);stateLoaded=new D;async loadState(e=!1){if(e){let o=await me();if(!o){console.log("No file selected, aborting.");return}this.state=JSON.parse(o)}else this.state=await this.storage.load();this.stateLoaded.resolve()}async saveState(e=!1){if(e){let o=JSON.stringify(this.state),r=new Blob([o],{type:"application/json"}),n=URL.createObjectURL(r),i=document.createElement("a");i.href=n,i.download="suno_colony.json",i.click(),URL.revokeObjectURL(n)}else await this.storage.save(this.state)}async build(){try{this.state.allPagesProcessed||await this.fetchClips(),this.state.allLinksBuilt||await this.buildLinks()}finally{await this.saveState()}}async fetchClips(){for(console.log("Fetching liked clips...");;){await Z(1e3);let{clips:e}=await ne.getClips(this.state.lastProcessedPage+1);if(!e.length){this.state.allPagesProcessed=!0;break}this.state.rawClips.push(...e),this.state.lastProcessedPage++,console.log(`Processed page ${this.state.lastProcessedPage}; total clips: ${this.state.rawClips.length}`)}}rawClipsById={};async loadClip(e){await Z(1e3);console.log(`Clip ${e} not found in cache, loading...`);let o=await ne.getClip(e)??Je(e);return this.state.rawClips.push(o),o}getClipByIdSync(e){return this.rawClipsById[e]??=this.state.rawClips.find(o=>ze(e)?o.audio_url.includes(e):o.id===e)}async getClipById(e){return e.startsWith("m_")&&(e=e.slice(2)),this.getClipByIdSync(e)??await this.loadClip(e)}async buildLinks(){console.log("Building links...");for(let e=0;e<this.state.rawClips.length;e++){let o=this.state.rawClips[e];e%100===0&&console.log(`Processed ${e} clips out of ${this.state.rawClips.length}`);let{metadata:r}=o,[n,i]="history"in r?I(r.history[0],a=>typeof a=="string"?[a,"extend"]:a.infill?[a.id,"inpaint"]:[a.id,"extend"]):"concat_history"in r?[r.concat_history[1].id,"apply"]:"cover_clip_id"in r?[r.cover_clip_id,"cover"]:"upsample_clip_id"in r?[r.upsample_clip_id,"remaster"]:"type"in r&&r.type==="edit_crop"?await he(o,this.state.rawClips).then(a=>a?[a,"crop"]:[void 0,void 0]):[void 0,void 0];n&&this.state.links.push([(await this.getClipById(n)).id,o.id,i])}this.state.allLinksBuilt=!0,console.log(`Built ${this.state.links.length} links.`),console.log("Colony built. Run `await vovas.colony.render()` to view it!")}_linkedClips;get linkedClips(){return this._linkedClips??=this.getLinkedClips()}getLinkedClips(){let e=this.state.links.reduce((r,[n,i,a])=>{let p=U(r,{id:n})??E(`Could not find parent for link ${n} -> ${i}.`),c=U(r,{id:i})??E(`Could not find child for link ${n} -> ${i}.`);if(c.parent)throw new Error(`Child ${i} already has a parent: ${c.parent.clip.id}`);return c.parent={kind:a,clip:p},(p.children??=[]).push({kind:a,clip:c}),r},K(this.state.rawClips));for(let r of e.filter(({parent:n})=>!n))o(r,r);return e;function o(r,n){Object.assign(r,{root:n});for(let{clip:i}of r.children??[])o(i,n)}}_rootClips;get rootClips(){return this._rootClips??=this.getRootClips()}getRootClips(){let e=this.linkedClips.filter(({parent:o})=>!o);return F(e)}get sortedClips(){let e=[],{rootClips:o}=this;for(let n of o)r(n);return e.reverse();function r(n){e.push(n);let{children:i}=n;if(i)for(let{clip:a}of F(i,({clip:p})=>p.created_at))r(a)}}get syntheticLinks(){let e=[],{rootClips:o}=this,r=o[0];for(let n of this.linkedClips.filter(({children:i})=>i?.length))e.push([(n.root??E(`Clip ${n.id} has no root.`)).id,n.id,"descendant"]);return e}getTotalDescendants(e){let o=U(this.linkedClips,{id:e})??E(`Clip ${e} not found.`);return o.totalDescendants??=1+(o.children?.reduce((r,{clip:{id:n}})=>r+this.getTotalDescendants(n),0)??0)}_graphData=void 0;getGraphData(){let e=this.sortedClips.map(({id:n,title:i,metadata:{tags:a},created_at:p,children:c,audio_url:f,image_url:m,root:b})=>({id:n,name:i||a||p||n,created_at:p,audio_url:f,image_url:m,tags:a,rootId:b?.id,val:n===b?.id&&c?.length?2:c?.length?1:.5})),o=([n,i,a])=>({source:n,target:i,kind:a,color:a==="next"?"#006":void 0,isMain:!Ye.includes(a)&&this.getTotalDescendants(i)>1});return{nodes:e,links:[...this.syntheticLinks,...this.state.links].map(o)}}get graphData(){return this._graphData??=this.getGraphData()}getHtml(e){return console.log("Rendering your colony, give it a few seconds..."),`<script>(vovas = {${window.vovas.main.toString()}}).main();vovas.colony.render(...${JSON.stringify([e,this.graphData])})<\/script>`}async render(e,o){console.log("Rendering your colony, give it a few seconds..."),this._graphData??=o,await re(this,this.graphData,{mode:e})}renderToFile(...e){let o=this.getHtml(...e),r=new Blob([o],{type:"text/html"}),n=URL.createObjectURL(r),i=document.createElement("a");i.href=n,i.download="suno_colony.html",i.click(),URL.revokeObjectURL(n)}},V=new G;V.stateLoaded.promise.then(async()=>{console.log("Welcome to Vova\u2019s Suno Colony! This is a nifty tool to visualize your liked clips and the relationships between them, such as extensions, inpaints, covers, etc., in a graph format. It takes a bit of time and hacks to build, but hopefully it\u2019ll be worth it!");let{state:{allPagesProcessed:t,allLinksBuilt:e}}=V;!t||!e?console.log("Run `await vovas.colony.build()` to start or continue building your colony!"):(console.log("Your colony is built, rendering!"),await V.render())});function ze(t){return t.match(/_\d+$/)}function Je(t){return console.warn(`Clip ${t} not found, creating a missing clip.`),{isMissing:!0,id:t,title:"*Clip not found*",created_at:null,audio_url:`https://cdn1.suno.ai/${t}.mp3`,image_url:"",metadata:{duration:0,tags:""}}}fe(window.vovas,{Colony:G,colony:V,debug:ye});})();
}}).main();
