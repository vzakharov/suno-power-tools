(vovas = { main() {
(()=>{function I(n,e){return n.find($e(e))}function $e(n){return function(e){return Object.entries(n).every(([t,o])=>e[t]===o)}}var Oe=0;function ie(n=""){return`${n}${++Oe}`}function Y(n,e){return Object.fromEntries(Object.entries(n).map(([t,o])=>[t,e(o,t)]))}function q(n,e){return Y(n,e)}function se(n,e){return Object.fromEntries(Object.entries(n).map(([t,o])=>[e(t,o),o]))}function z(n){return typeof n=="function"}function ae(n,e){return Object.assign(n,e)}function J(){return[]}function de(n,e){return e(n)}function P(n){return JSON.parse(JSON.stringify(n))}function pe(n,e){Object.assign(n,e)}var le=0;function Q(n){let e=Math.max(0,n-(Date.now()-le));return new Promise(t=>{setTimeout(()=>{le=Date.now(),t()},e)})}function v(n){throw new Error(n)}async function ue(){let n=document.createElement("input");return n.type="file",n.click(),new Promise(e=>{n.onchange=()=>{let t=n.files?.[0];if(!t)return e(void 0);let o=new FileReader;o.onload=()=>{e(o.result),n.remove()},o.readAsText(t)}})}function ce(n){return n?new Date(n).getTime():0}function R(n,e=t=>t.created_at){return n.sort((t,o)=>ce(e(t))-ce(e(o)))}function fe(n,e){return se(n,t=>e[t]??t)}async function he(n,e){for(let t of e.slice(e.findIndex(o=>o.id===n.id)+1))if(t!==n&&t.metadata.tags===n.metadata.tags&&await je(t.image_url,n.image_url))return console.warn(`Found potential base clip for cropped clip ${n.id}: ${t.id} (this is not guaranteed to be correct)`),t.id;console.warn(`Could not find a base clip for cropped clip ${n.id}, the clip will be mistakenly marked as a root clip.`)}async function Te(n){let t=await(await fetch(n)).blob();return new Promise((o,r)=>{let i=new Image;i.onload=()=>{URL.revokeObjectURL(i.src),o(i)},i.onerror=r,i.src=URL.createObjectURL(t)})}async function je(n,e){let t=await Te(n),o=await Te(e),r=document.createElement("canvas");r.width=t.width,r.height=t.height;let i=r.getContext("2d")??v("Canvas 2D context not supported");i.drawImage(t,0,0);let s=i.getImageData(0,0,t.width,t.height);i.drawImage(o,0,0);let l=i.getImageData(0,0,o.width,o.height),d=s.data,f=l.data,T=d.length,x=0;for(let k=0;k<T;k+=4)for(let b=0;b<3;b++)x+=Math.abs(d[k+b]-f[k+b]);let E=x/(T/4);return r.remove(),E<32;}var U=class{resolve;reject;promise;constructor(){this.promise=new Promise((e,t)=>Object.assign(this,{resolve:e,reject:t}))}};var We="vovas",S="sunoTools",Ge=new Promise((n,e)=>{let t=indexedDB.open(We,1);t.onupgradeneeded=()=>t.result.createObjectStore(S),t.onsuccess=()=>n(t.result),t.onerror=()=>e(t.error)});async function X(n){return(await Ge).transaction(S,n)}function me(n){return new Promise((e,t)=>{n.oncomplete=()=>e(),n.onerror=()=>t(n.error)})}async function He(n){return(await X(n)).objectStore(S)}var D=class{constructor(e,t){this.key=e;this.init=t}async load(){let e=(await He("readonly")).get(this.key);return new Promise((t,o)=>{e.onsuccess=()=>t(e.result??this.init),e.onerror=()=>o(e.error)})}async save(e){let t=await X("readwrite");return t.objectStore(S).put(e,this.key),me(t)}async clear(){let e=await X("readwrite");return e.objectStore(S).delete(this.key),me(e)}};var M=class extends Error{constructor(e){super(`smork: ${e}`)}};function g(n,e){return z(n)?ge(n,e):new L(n)}var C=class{constructor(e){this._value=e}watchers=new Set;activeWatchers=new WeakSet;get(){return _?.(this),this._value}_set(e){let{_value:t}=this;if(e!==this._value){this._value=e;try{for(let o of this.watchers){if(this.activeWatchers.has(o)){console.warn("smork: watcher is already active \u2014 perhaps a circular dependency \u2014 exiting watch to prevent infinite loop");return}this.activeWatchers.add(o),o(e,t)}}finally{this.activeWatchers=new WeakSet}}}runAndWatch(e){e(this._value,this._value),this.watch(e)}watchImmediate=this.runAndWatch;watch(e){this.watchers.add(e)}onChange=this.watch;unwatch(e){this.watchers.delete(e)}get value(){return this.get()}map(e){let t=new A(this,e);return z(t.value)?(this.unwatch(t.update),(...o)=>new A(this,r=>e(r)(...o))):t}merge(e){return e?ge(()=>({...this.value,...Ve(e)})):this}uses(e){return ae(this,Y(e,this.map))}onceDefined(e){let t=o=>{o&&(this.unwatch(t),e(o))};this.watchImmediate(t)}},A=class extends C{constructor(t,o){var e=(...ut)=>(super(...ut),this.dependency=t,this.mapper=o,this);t&&(e(o(t.value)),t.watch(this.update))}update=t=>this._set(this.mapper(t))},L=class extends C{set(e){this._set(e)}set value(e){this.set(e)}get value(){return this.get()}bridge(e,t){return new B(()=>e(this.value),o=>this.set(t(o)))}};function ye(n){return e=>{n.set(e)}}var _,F=class extends L{constructor(t){super(void 0);this.getter=t;this.track()}dependencies=new Set;track=()=>{if(_)throw new M("Tried to compute a ref while another one is already being computed \u2014 did you nest a computed ref in another ref's getter function?");this.dependencies.forEach(t=>t.unwatch(this.track)),this.dependencies=new Set;try{_=t=>{t.watch(this.track),this.dependencies.add(t)},this._set(this.getter())}finally{_=void 0}}},B=class extends L{constructor(t,o,r=!1){let i=new F(t);super(i.value);this.setter=o;this.allowMismatch=r;i.watch(s=>this._set(s))}set(t){if(this.setter(t),!this.allowMismatch&&this.value!==t)throw new M("Setter did not update the value. If you want to allow this, set the allowMismatch property to true.")}};function ge(n,e){return e?new B(n,e):new F(n)}function xe(n){return(e,t)=>n instanceof C?e(n):t(n)}function Ve(n){return xe(n)(e=>e.value,e=>e)}function we(n,e){xe(n)(t=>t.watchImmediate(e),e)}var Ye=["html","head","style","script","body","div","h3","p","a","img","audio","input","label","button"],qe=Je(Ye),{html:vt,head:Ct,style:ke,script:Rt,body:St,div:u,h3:ve,p:Ce,a:Re,img:Se,audio:Le,input:Lt,label:ze,button:N}=qe;function Je(n){return n.reduce((e,t)=>Object.assign(e,{[t]:Ne(t)}),{})}function Ne(n){function e(o,r){let[i,s]=Array.isArray(o)?[void 0,o]:[o,r];return t(i,s)}return e;function t(o,r){let i=document.createElement(n);return o&&q(fe(o,{class:"className",for:"htmlFor"}),(s,l)=>{we(s,d=>{l!=="style"?i[l]=d:q(d,(f,T)=>i.style[T]=f)})}),r&&r.forEach(s=>{let l=void 0,d=f=>{let T=typeof f=="string"?document.createTextNode(f):f instanceof HTMLElement?f:document.createComment("");l?l.replaceWith(T):i.appendChild(T),l=T};s instanceof C?s.watchImmediate(d):d(s)}),i}}var $=Ke("input","checked",{type:"checkbox"},n=>({onchange:()=>n.set(!n.value)})),Ee=Ke("input","value",{type:"text"},n=>({onkeyup:({key:e,target:t})=>{e==="Enter"&&t instanceof HTMLInputElement&&n.set(t.value)}}));function Ke(n,e,t,o){return(r,i)=>Ne(n)({...t,...i,[e]:r,...o(r)})}function O(n,e){e.id||=ie("smork-input-");let t=[ze({for:e.id},[n]),e];return e.type==="checkbox"&&t.reverse(),t}async function Ie(n,e,t){let o=n.document.createElement("script");return o.type="text/javascript",o.src=t,n.document.head.appendChild(o),new Promise(r=>{o.onload=()=>{r(n[e])}})}function j(n,e,t=void 0){return n.map(o=>o?e:t)}function Z({id:n,image_url:e,name:t,tags:o}){return u({class:"relative"},[Re({href:`https://suno.com/song/${n}`,target:"_blank"},[Se({src:e,style:{opacity:"0.5",width:"200px"}}),u({class:"absolute topleft",style:{width:"190px",padding:"5px"}},[u(t||"[Untitled]"),u({class:"smol"},[o||"(no style)"])])])])}var Pe='.colony { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;}.colony button {background-color: #444;color: #eee}.colony #sidebar {position: fixed;padding: 10px;top: 0;left: 0;bottom: 0;width: 200px;background-color: #333;color: #eee;display: flex;flex-direction: column;justify-content: space-between;}.colony .f-row {display: flex;flex-direction: row;}.colony .f-col {display: flex;flex-direction: column;}.colony .smol {font-size: 0.8em;color: #aaa;}.colony .relative {position: relative;}.colony .absolute {position: absolute;}.colony .topleft {top: 0;left: 0;}.colony .p-1 {padding: 1rem;};.colony .p-2 {padding: 2rem;}.colony .w-100 {width: 100%;}.colony .h-100 {height: 100%;}.colony .j-between {justify-content: space-between;}.colony .settings > * {margin-top: 5px;}';async function ee(n,e,{mode:t=void 0}){let o=t?.toLowerCase()==="3d",r=g(!1),i=r.map(a=>!a),s=g();s.onceDefined(Me);let l=g(),d=l.map(a=>a?.graphData()),f=g(!0),T=g(!1),x=g(!0),E=g(""),k=g(),b=g();b.onChange(()=>setTimeout(()=>{k.value?.play()},0));let De=await Ie(window,"ForceGraph",`https://unpkg.com/${o?"3d-":""}force-graph`);window.document.head.appendChild(ke([Pe]));let _e=P(e);function Me(a){l.value=new De(a).graphData(_e).backgroundColor("#001").linkAutoColorBy("kind").nodeAutoColorBy("rootId").linkLabel("kind").linkVisibility(oe).linkDirectionalParticles(1).nodeLabel(p=>u([Z(p),u({class:"smol"},["Click to play, right-click to open in Suno"])]).outerHTML).onNodeClick(ye(b)).onNodeRightClick(({id:p})=>{window.open(`https://suno.com/song/${p}`)}),o?l.value.linkOpacity(p=>p.isMain?1:.2):l.value.linkLineDash(p=>p.isMain?null:[1,2])}async function Ae(){new FinalizationRegistry(()=>console.log("Previous graph destroyed, container removed from memory")).register(l,""),l.value?._destructor(),Fe.remove(),await ee(this,e,{mode:t})}function oe(a){return!{descendant:!0,next:!T.value}[a.kind]}function re(a,p){if(!d.value||!l.value)return;let{nodes:w,links:y}=d.value;if(p?y.push(...d.value.links.filter(m=>m.kind===a)):y=y.filter(m=>m.kind!==a),a==="next"&&(y=y.filter(m=>m.kind!=="next"),p)){R(w);for(let m=1;m<w.length;m++){let c=w[m-1],h=w[m];y.push({source:c.id,target:h.id,kind:"next",color:"#006",isMain:!1})}}l.value.graphData({nodes:w,links:y})}f.watchImmediate(a=>re("next",a)),x.watchImmediate(a=>re("descendant",a)),T.watchImmediate(()=>{l.value?.linkVisibility(oe)});function K(a){return typeof a=="string"?a:a.id}function H(a,p){return K(a)===K(p)}function V(a){return p=>H(a,p)}E.watchImmediate(a=>{if(!d.value||!l.value)return;a=a?.toLowerCase();let p=a?d.value.nodes.filter(c=>`${c.id} ${c.name} ${c.tags} ${c.created_at}`.toLowerCase().includes(a)):d.value.nodes,w=l.value.graphData(),y=[...p.map(c=>w.nodes.find(V(c))??c),...a?d.value.nodes.filter(c=>p.some(h=>h.rootId===c.rootId&&h.id!==c.id)):[]].map(c=>w.nodes.find(h=>h.id===c.id)??c),m=d.value.links.filter(c=>y.some(V(c.source))&&y.some(V(c.target))).map(({source:c,target:h,...Be})=>({source:K(c),target:K(h),...Be})).map(c=>w.links.find(h=>H(c.source,h.source)&&H(c.target,h.target))??c);l.value.graphData({nodes:y,links:m}),a?l.value.nodeVal(c=>p.some(h=>h.id===c.id)?3:c.val):l.value.nodeVal("val")}),setTimeout(()=>{f.set(!1),x.set(!1)},2e3);let Fe=document.body.appendChild(u({class:"colony",style:{position:"fixed",top:"0px",left:"0px",zIndex:"100"}},[j(i,u({style:{flexDirection:"column",height:"100vh",width:"100vh",backgroundColor:"#000"}},[s.value=u(),u({id:"sidebar"},[u({class:"settings f-col"},[N({style:{marginBottom:"5px"},onclick:()=>r.set(!0)},["Close Colony"]),ve(["Settings"]),u(O("Attract based on time",$(f))),j(f,u(O("Show time-based links",$(T)))),u(O("Attract to root clip",$(x))),u([Ee(E,{placeholder:"Filter by name, style or ID"}),Ce({class:"smol"},["Enter to apply. (Filter will include both matching nodes and any nodes belonging to the same root clip.)"])]),N({onclick:Ae},["Redraw"]),N({onclick:()=>n.renderToFile(t)},["Download"])]),j(b,a=>u({class:"w-100"},[Z(a),k.value=Le({src:a.audio_url,controls:!0,class:"w-100"})]))])]),N({style:{position:"fixed",top:"0px",left:"0px",padding:"5px",zIndex:"100"},onclick:()=>r.set(!1)},["Reopen Colony"]))]))}var Qe="https://studio-api.prod.suno.com/api/";function Ue(n,e){return async(...t)=>{let o=n(...t),r=await fetch(Qe+o,{headers:{authorization:`Bearer ${await window.Clerk.session.getToken()}`}});if(r.status===404&&e){console.warn(`Could not find resource at ${o}, returning undefined`);return}return await r.json()}}var te={getClips:Ue(n=>"feed/v2?is_liked=true&page="+n),getClip:Ue(n=>"clip/"+n,!0)};var Xe=["next","descendant"];var ne={rawClips:J(),lastProcessedPage:-1,allPagesProcessed:!1,links:J(),allLinksBuilt:!1},G=class{constructor(e=ne){this.state=e;this.loadState()}reset(){this.state=ne,console.log("Colony reset. Run build() to start building it again.")}storage=new D("colony",ne);stateLoaded=new U;async loadState(e=!1){if(e){let t=await ue();if(!t){console.log("No file selected, aborting.");return}this.state=JSON.parse(t)}else this.state=await this.storage.load();this.stateLoaded.resolve()}async saveState(e=!1){if(e){let t=JSON.stringify(this.state),o=new Blob([t],{type:"application/json"}),r=URL.createObjectURL(o),i=document.createElement("a");i.href=r,i.download="suno_colony.json",i.click(),URL.revokeObjectURL(r)}else await this.storage.save(this.state)}async build(){try{this.state.allPagesProcessed||await this.fetchClips(),this.state.allLinksBuilt||await this.buildLinks()}finally{await this.saveState()}}async fetchClips(){for(console.log("Fetching liked clips...");;){await Q(1e3);let{clips:e}=await te.getClips(this.state.lastProcessedPage+1);if(!e.length){this.state.allPagesProcessed=!0;break}this.state.rawClips.push(...e),this.state.lastProcessedPage++,console.log(`Processed page ${this.state.lastProcessedPage}; total clips: ${this.state.rawClips.length}`)}}rawClipsById={};async loadClip(e){await Q(1e3);console.log(`Clip ${e} not found in cache, loading...`);let t=await te.getClip(e)??et(e);return this.state.rawClips.push(t),t}getClipByIdSync(e){return this.rawClipsById[e]??=this.state.rawClips.find(t=>Ze(e)?t.audio_url.includes(e):t.id===e)}async getClipById(e){return e.startsWith("m_")&&(e=e.slice(2)),this.getClipByIdSync(e)??await this.loadClip(e)}async buildLinks(){console.log("Building links...");for(let e=0;e<this.state.rawClips.length;e++){let t=this.state.rawClips[e];e%100===0&&console.log(`Processed ${e} clips out of ${this.state.rawClips.length}`);let{metadata:o}=t,[r,i]="history"in o?de(o.history[0],s=>typeof s=="string"?[s,"extend"]:s.infill?[s.id,"inpaint"]:[s.id,"extend"]):"concat_history"in o?[o.concat_history[1].id,"apply"]:"cover_clip_id"in o?[o.cover_clip_id,"cover"]:"upsample_clip_id"in o?[o.upsample_clip_id,"remaster"]:"type"in o&&o.type==="edit_crop"?await he(t,this.state.rawClips).then(s=>s?[s,"crop"]:[void 0,void 0]):[void 0,void 0];r&&this.state.links.push([(await this.getClipById(r)).id,t.id,i])}this.state.allLinksBuilt=!0,console.log(`Built ${this.state.links.length} links.`),console.log("Colony built. Run `await vovas.colony.render()` to view it!")}_linkedClips;get linkedClips(){return this._linkedClips??=this.getLinkedClips()}getLinkedClips(){let e=this.state.links.reduce((o,[r,i,s])=>{let l=I(o,{id:r})??v(`Could not find parent for link ${r} -> ${i}.`),d=I(o,{id:i})??v(`Could not find child for link ${r} -> ${i}.`);if(d.parent)throw new Error(`Child ${i} already has a parent: ${d.parent.clip.id}`);return d.parent={kind:s,clip:l},(l.children??=[]).push({kind:s,clip:d}),o},P(this.state.rawClips));for(let o of e.filter(({parent:r})=>!r))t(o,o);return e;function t(o,r){Object.assign(o,{root:r});for(let{clip:i}of o.children??[])t(i,r)}}_rootClips;get rootClips(){return this._rootClips??=this.getRootClips()}getRootClips(){let e=this.linkedClips.filter(({parent:t})=>!t);return R(e)}get sortedClips(){let e=[],{rootClips:t}=this;for(let r of t)o(r);return e.reverse();function o(r){e.push(r);let{children:i}=r;if(i)for(let{clip:s}of R(i,({clip:l})=>l.created_at))o(s)}}get syntheticLinks(){let e=[],{rootClips:t}=this,o=t[0];for(let r of this.linkedClips.filter(({children:i})=>i?.length))e.push([(r.root??v(`Clip ${r.id} has no root.`)).id,r.id,"descendant"]);return e}getTotalDescendants(e){let t=I(this.linkedClips,{id:e})??v(`Clip ${e} not found.`);return t.totalDescendants??=1+(t.children?.reduce((o,{clip:{id:r}})=>o+this.getTotalDescendants(r),0)??0)}_graphData=void 0;getGraphData(){let e=this.sortedClips.map(({id:r,title:i,metadata:{tags:s},created_at:l,children:d,audio_url:f,image_url:T,root:x})=>({id:r,name:i||s||l||r,created_at:l,audio_url:f,image_url:T,tags:s,rootId:x?.id,val:r===x?.id&&d?.length?2:d?.length?1:.5})),t=([r,i,s])=>({source:r,target:i,kind:s,color:s==="next"?"#006":void 0,isMain:!Xe.includes(s)&&this.getTotalDescendants(i)>1});return{nodes:e,links:[...this.syntheticLinks,...this.state.links].map(t)}}get graphData(){return this._graphData??=this.getGraphData()}getHtml(e){return console.log("Rendering your colony, give it a few seconds..."),`<script>(vovas = {${window.vovas.main.toString()}}).main();vovas.colony.render(...${JSON.stringify([e,this.graphData])})<\/script>`}async render(e,t){console.log("Rendering your colony, give it a few seconds..."),this._graphData??=t,await ee(this,this.graphData,{mode:e})}renderToFile(...e){let t=this.getHtml(...e),o=new Blob([t],{type:"text/html"}),r=URL.createObjectURL(o),i=document.createElement("a");i.href=r,i.download="suno_colony.html",i.click(),URL.revokeObjectURL(r)}},W=new G;W.stateLoaded.promise.then(async()=>{console.log("Welcome to Vova\u2019s Suno Colony! This is a nifty tool to visualize your liked clips and the relationships between them, such as extensions, inpaints, covers, etc., in a graph format. It takes a bit of time and hacks to build, but hopefully it\u2019ll be worth it!");let{state:{allPagesProcessed:n,allLinksBuilt:e}}=W;!n||!e?console.log("Run `await vovas.colony.build()` to start or continue building your colony!"):(console.log("Your colony is built, rendering!"),await W.render())});function Ze(n){return n.match(/_\d+$/)}function et(n){return console.warn(`Clip ${n} not found, creating a missing clip.`),{isMissing:!0,id:n,title:"*Clip not found*",created_at:null,audio_url:`https://cdn1.suno.ai/${n}.mp3`,image_url:"",metadata:{duration:0,tags:""}}}pe(window.vovas,{Colony:G,colony:W});})();
}}).main();
