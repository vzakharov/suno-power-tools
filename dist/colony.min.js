(vovas = { main() {
(()=>{function I(o,e){return o.find(Oe(e))}function Oe(o){return function(e){return Object.entries(o).every(([t,n])=>e[t]===n)}}var We=0;function se(o=""){return`${o}${++We}`}function Y(o,e){return Object.fromEntries(Object.entries(o).map(([t,n])=>[t,e(n,t)]))}function pe(o,e){return Y(o,e)}function J(o){return typeof o=="function"}function le(o,e){return Object.assign(o,e)}function Q(){return[]}function K(o,e){return e(o)}function U(o){return JSON.parse(JSON.stringify(o))}function ue(o,e){Object.assign(o,e)}var ce=0;function X(o){let e=Math.max(0,o-(Date.now()-ce));return new Promise(t=>{setTimeout(()=>{ce=Date.now(),t()},e)})}function k(o){throw new Error(o)}async function ye(){let o=document.createElement("input");return o.type="file",o.click(),new Promise(e=>{o.onchange=()=>{let t=o.files?.[0];if(!t)return e(void 0);let n=new FileReader;n.onload=()=>{e(n.result),o.remove()},n.readAsText(t)}})}function de(o){return o?new Date(o).getTime():0}function C(o,e=t=>t.created_at){return o.sort((t,n)=>de(e(t))-de(e(n)))}function fe(){debugger}async function Te(o,e){for(let t of e.slice(e.findIndex(n=>n.id===o.id)+1))if(t!==o&&t.metadata.tags===o.metadata.tags&&await Ge(t.image_url,o.image_url))return console.warn(`Found potential base clip for cropped clip ${o.id}: ${t.id} (this is not guaranteed to be correct)`),t.id;console.warn(`Could not find a base clip for cropped clip ${o.id}, the clip will be mistakenly marked as a root clip.`)}async function ge(o){let t=await(await fetch(o)).blob();return new Promise((n,r)=>{let a=new Image;a.onload=()=>{URL.revokeObjectURL(a.src),n(a)},a.onerror=r,a.src=URL.createObjectURL(t)})}async function Ge(o,e){let t=await ge(o),n=await ge(e),r=document.createElement("canvas");r.width=t.width,r.height=t.height;let a=r.getContext("2d")??k("Canvas 2D context not supported");a.drawImage(t,0,0);let i=a.getImageData(0,0,t.width,t.height);a.drawImage(n,0,0);let s=a.getImageData(0,0,n.width,n.height),c=i.data,y=s.data,f=c.length,x=0;for(let v=0;v<f;v+=4)for(let w=0;w<3;w++)x+=Math.abs(c[v+w]-y[v+w]);let A=x/(f/4);return r.remove(),A<32;}var P=class{resolve;reject;promise;constructor(){this.promise=new Promise((e,t)=>Object.assign(this,{resolve:e,reject:t}))}};var He="vovas",S="sunoTools",Ve=new Promise((o,e)=>{let t=indexedDB.open(He,1);t.onupgradeneeded=()=>t.result.createObjectStore(S),t.onsuccess=()=>o(t.result),t.onerror=()=>e(t.error)});async function Z(o){return(await Ve).transaction(S,o)}function me(o){return new Promise((e,t)=>{o.oncomplete=()=>e(),o.onerror=()=>t(o.error)})}async function qe(o){return(await Z(o)).objectStore(S)}var D=class{constructor(e,t){this.key=e;this.init=t}async load(){let e=(await qe("readonly")).get(this.key);return new Promise((t,n)=>{e.onsuccess=()=>t(e.result??this.init),e.onerror=()=>n(e.error)})}async save(e){let t=await Z("readwrite");return t.objectStore(S).put(e,this.key),me(t)}async clear(){let e=await Z("readwrite");return e.objectStore(S).delete(this.key),me(e)}};var F=class extends Error{constructor(e){super(`smork: ${e}`)}};function h(o,e){return J(o)?xe(o,e):new L(o)}var R=class{constructor(e){this._value=e}watchers=new Set;activeWatchers=new WeakSet;get(){return _?.(this),this._value}_set(e){let{_value:t}=this;if(e!==this._value){this._value=e;try{for(let n of this.watchers){if(this.activeWatchers.has(n)){console.warn("smork: watcher is already active \u2014 perhaps a circular dependency \u2014 exiting watch to prevent infinite loop");return}this.activeWatchers.add(n),n(e,t)}}finally{this.activeWatchers=new WeakSet}}}runAndWatch(e){e(this._value,this._value),this.watch(e)}watchImmediate=this.runAndWatch;watch(e){this.watchers.add(e)}onChange=this.watch;unwatch(e){this.watchers.delete(e)}get value(){return this.get()}map(e){let t=new M(this,e);return J(t.value)?(this.unwatch(t.update),(...n)=>new M(this,r=>e(r)(...n))):t}merge(e){return e?xe(()=>({...this.value,...ee(e)})):this}uses(e){return le(this,Y(e,this.map))}onceDefined(e){let t=n=>{n&&(this.unwatch(t),e(n))};this.watchImmediate(t)}},M=class extends R{constructor(t,n){var e=(...ct)=>(super(...ct),this.dependency=t,this.mapper=n,this);t&&(e(n(t.value)),t.watch(this.update))}update=t=>this._set(this.mapper(t))},L=class extends R{set(e){this._set(e)}set value(e){this.set(e)}get value(){return this.get()}bridge(e,t){return new B(()=>e(this.value),n=>this.set(t(n)))}};function he(o){return e=>{o.set(e)}}var _,$=class extends L{constructor(t){super(void 0);this.getter=t;this.track()}dependencies=new Set;track=()=>{if(_)throw new F("Tried to compute a ref while another one is already being computed \u2014 did you nest a computed ref in another ref's getter function?");this.dependencies.forEach(t=>t.unwatch(this.track)),this.dependencies=new Set;try{_=t=>{t.watch(this.track),this.dependencies.add(t)},this._set(this.getter())}finally{_=void 0}}},B=class extends L{constructor(t,n,r=!1){let a=new $(t);super(a.value);this.setter=n;this.allowMismatch=r;a.watch(i=>this._set(i))}set(t){if(this.setter(t),!this.allowMismatch&&this.value!==t)throw new F("Setter did not update the value. If you want to allow this, set the allowMismatch property to true.")}};function xe(o,e){return e?new B(o,e):new $(o)}function ee(o){return o instanceof R?o.value:o}function be(o){return o instanceof R?o:new R(o)}var Re=["a","abbr","address","area","article","aside","audio","b","base","bdi","bdo","blockquote","body","br","button","canvas","caption","cite","code","col","colgroup","data","datalist","dd","del","details","dfn","dialog","div","dl","dt","em","embed","fieldset","figcaption","figure","footer","form","h1","h2","h3","h4","h5","h6","head","header","hgroup","hr","html","i","iframe","img","input","ins","kbd","label","legend","li","link","main","map","mark","menu","meta","meter","nav","noscript","object","ol","optgroup","option","output","p","picture","pre","progress","q","rp","rt","ruby","s","samp","script","search","section","select","slot","small","source","span","strong","style","sub","summary","sup","table","tbody","td","template","textarea","tfoot","th","thead","time","title","tr","track","u","ul","var","video","wbr"];var{a:we,abbr:ft,address:gt,area:Tt,article:mt,aside:ht,audio:ve,b:xt,base:bt,bdi:Rt,bdo:wt,blockquote:vt,body:kt,br:Ct,button:N,canvas:St,caption:Lt,cite:Nt,code:At,col:Et,colgroup:It,data:Kt,datalist:Ut,dd:Pt,del:Dt,details:_t,dfn:Ft,dialog:Mt,div:u,dl:$t,dt:Bt,em:jt,embed:Ot,fieldset:Wt,figcaption:Gt,figure:Ht,footer:Vt,form:qt,h1:zt,h2:Yt,h3:ke,h4:Jt,h5:Qt,h6:Xt,head:Zt,header:eo,hgroup:to,hr:oo,html:no,i:ro,iframe:ao,img:Ce,input:io,ins:so,kbd:po,label:Se,legend:lo,li:co,link:uo,main:yo,map:fo,mark:go,menu:To,meta:mo,meter:ho,nav:xo,noscript:bo,object:Ro,ol:wo,optgroup:vo,option:ko,output:Co,p:Le,picture:So,pre:Lo,progress:No,q:Ao,rp:Eo,rt:Io,ruby:Ko,s:Uo,samp:Po,script:Do,search:_o,section:Fo,select:Mo,slot:$o,small:Bo,source:jo,span:Oo,strong:Wo,style:Ne,sub:Go,summary:Ho,sup:Vo,table:qo,tbody:zo,td:Yo,template:Jo,textarea:Qo,tfoot:Xo,th:Zo,thead:en,time:tn,title:on,tr:nn,track:rn,u:an,ul:sn,var:pn,video:ln,wbr:cn}=Re.reduce((o,e)=>(o[e]=Ae(e),o),{});function Ae(o){function e(n,r){let[a,i]=Array.isArray(n)?[void 0,n]:[n,r];return t(a,i)}return e;function t(n,r){let a=document.createElement(o);return n&&pe(n,(i,s)=>{typeof i=="function"?a[s==="style"?"cssText":s]=i():K(i,c=>{y(ee(c)),be(c).watch(y);function y(f){typeof f=="boolean"?f?a.setAttribute(s,""):a.removeAttribute(s):a.setAttribute(s,String(f))}})}),r&&r.forEach(i=>{let s=void 0,c=y=>{let f=typeof y=="string"?document.createTextNode(y):y instanceof HTMLElement?y:document.createComment("");s?s.replaceWith(f):a.appendChild(f),s=f};i instanceof R?i.watchImmediate(c):c(i)}),a}}var j=Ke("input","checked",Boolean,{type:"checkbox"},o=>({onchange:()=>o.set(!o.value)})),Ie=Ke("input","value",String,{type:"text"},o=>({onkeyup:({key:e,target:t})=>{e==="Enter"&&t instanceof HTMLInputElement&&o.set(t.value)}}));function Ke(o,e,t,n){return(r,a)=>o(o)({...t,...a,[e]:r,...n(r)})}function O(o,e){e.id||=se("smork-input-");let t=[Se({for:e.id},[o]),e];return e.type==="checkbox"&&t.reverse(),t}async function Ue(o,e,t){let n=o.document.createElement("script");return n.type="text/javascript",n.src=t,o.document.head.appendChild(n),new Promise(r=>{n.onload=()=>{r(o[e])}})}function W(o,e,t=void 0){return o.map(n=>n?e:t)}function te({id:o,image_url:e,name:t,tags:n}){return u({class:"relative"},[we({href:`https://suno.com/song/${o}`,target:"_blank"},[Ce({src:e,style:"opacity: 0.5; width: 200px"}),u({class:"absolute topleft",style:"width: 190px; padding: 5px"},[u([t||"[Untitled]"]),u({class:"smol"},[n||"(no style)"])])])])}var Pe='.colony { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;}.colony button {background-color: #444;color: #eee}.colony #sidebar {position: fixed;padding: 10px;top: 0;left: 0;bottom: 0;width: 200px;background-color: #333;color: #eee;display: flex;flex-direction: column;justify-content: space-between;}.colony .f-row {display: flex;flex-direction: row;}.colony .f-col {display: flex;flex-direction: column;}.colony .smol {font-size: 0.8em;color: #aaa;}.colony .relative {position: relative;}.colony .absolute {position: absolute;}.colony .topleft {top: 0;left: 0;}.colony .p-1 {padding: 1rem;};.colony .p-2 {padding: 2rem;}.colony .w-100 {width: 100%;}.colony .h-100 {height: 100%;}.colony .j-between {justify-content: space-between;}.colony .settings > * {margin-top: 5px;}';async function oe(o,e,{mode:t=void 0}){let n=t?.toLowerCase()==="3d",r=h(!1),a=r.map(p=>!p),i=h();i.onceDefined(Me);let s=h(),c=s.map(p=>p?.graphData()),y=h(!0),f=h(!1),x=h(!0),A=h(""),v=h(),w=h();w.onChange(()=>setTimeout(()=>{v.value?.play()},0));let _e=await Ue(window,"ForceGraph",`https://unpkg.com/${n?"3d-":""}force-graph`);window.document.head.appendChild(Ne([Pe]));let Fe=U(e);function Me(p){s.value=new _e(p).graphData(Fe).backgroundColor("#001").linkAutoColorBy("kind").nodeAutoColorBy("rootId").linkLabel("kind").linkVisibility(ae).linkDirectionalParticles(1).nodeLabel(d=>u([te(d),u({class:"smol"},["Click to play, right-click to open in Suno"])]).outerHTML).onNodeClick(he(w)).onNodeRightClick(({id:d})=>{window.open(`https://suno.com/song/${d}`)}),n?s.value.linkOpacity(d=>d.isMain?1:.2):s.value.linkLineDash(d=>d.isMain?null:[1,2])}async function $e(){new FinalizationRegistry(()=>console.log("Previous graph destroyed, container removed from memory")).register(s,""),s.value?._destructor(),Be.remove(),await oe(this,e,{mode:t})}function ae(p){return!{descendant:!0,next:!f.value}[p.kind]}function ie(p,d){if(!c.value||!s.value)return;let{nodes:b,links:T}=c.value;if(d?T.push(...c.value.links.filter(g=>g.kind===p)):T=T.filter(g=>g.kind!==p),p==="next"&&(T=T.filter(g=>g.kind!=="next"),d)){C(b);for(let g=1;g<b.length;g++){let z=b[g-1],l=b[g];T.push({source:z.id,target:l.id,kind:"next",color:"#006",isMain:!1})}}s.value.graphData({nodes:b,links:T})}y.watchImmediate(p=>ie("next",p)),x.watchImmediate(p=>ie("descendant",p)),f.watchImmediate(()=>{s.value?.linkVisibility(ae)});function E(p){return typeof p=="string"?p:p.id}function V(p,d){return E(p)===E(d)}function q(p){return d=>V(p,d)}A.watchImmediate(p=>{if(!c.value||!s.value)return;let d=p?.toLowerCase(),b=d?c.value.nodes.filter(l=>`${l.id} ${l.name} ${l.tags} ${l.created_at}`.toLowerCase().includes(d)):c.value.nodes,T=s.value.graphData(),g=[...b.map(l=>T.nodes.find(q(l))??l),...d?c.value.nodes.filter(l=>b.some(m=>m.rootId===l.rootId&&m.id!==l.id)):[]].map(l=>T.nodes.find(m=>m.id===l.id)??l),z=c.value.links.filter(l=>g.some(q(l.source))&&g.some(q(l.target))).map(({source:l,target:m,...je})=>({source:E(l),target:E(m),...je})).map(l=>T.links.find(m=>V(l.source,m.source)&&V(l.target,m.target))??l);s.value.graphData({nodes:g,links:z}),d?s.value.nodeVal(l=>b.some(m=>m.id===l.id)?3:l.val):s.value.nodeVal("val")}),setTimeout(()=>{y.set(!1),x.set(!1)},2e3);let Be=document.body.appendChild(u({class:"colony",style:"position: fixed; top: 0px; left: 0px; z-index: 100;"},[W(a,u({style:"flex-direction: column; height: 100vh; width: 100vh; background-color: #000;"},[i.value=u(),u({id:"sidebar"},[u({class:"settings f-col"},[N({style:"margin-bottom: 5px;",onclick:()=>r.set(!0)},["Close Colony"]),ke(["Settings"]),u(O("Attract based on time",j(y))),W(y,u(O("Show time-based links",j(f)))),u(O("Attract to root clip",j(x))),u([Ie(A,{placeholder:"Filter by name, style or ID"}),Le({class:"smol"},["Enter to apply. (Filter will include both matching nodes and any nodes belonging to the same root clip.)"])]),N({onclick:$e},["Redraw"]),N({onclick:()=>o.renderToFile(t)},["Download"])]),W(w,p=>u({class:"w-100"},[te(p),v.value=ve({src:p.audio_url,controls:!0,class:"w-100"})]))])]),N({style:"position: fixed; top: 0px; left: 0px; padding: 5px; z-index: 100;",onclick:()=>r.set(!1)},["Reopen Colony"]))]))}var ze="https://studio-api.prod.suno.com/api/";function De(o,e){return async(...t)=>{let n=o(...t),r=await fetch(ze+n,{headers:{authorization:`Bearer ${await window.Clerk.session.getToken()}`}});if(r.status===404&&e){console.warn(`Could not find resource at ${n}, returning undefined`);return}return await r.json()}}var ne={getClips:De(o=>"feed/v2?is_liked=true&page="+o),getClip:De(o=>"clip/"+o,!0)};var Ye=["next","descendant"];var re={rawClips:Q(),lastProcessedPage:-1,allPagesProcessed:!1,links:Q(),allLinksBuilt:!1},H=class{constructor(e=re){this.state=e;this.loadState()}reset(){this.state=re,console.log("Colony reset. Run build() to start building it again.")}storage=new D("colony",re);stateLoaded=new P;async loadState(e=!1){if(e){let t=await ye();if(!t){console.log("No file selected, aborting.");return}this.state=JSON.parse(t)}else this.state=await this.storage.load();this.stateLoaded.resolve()}async saveState(e=!1){if(e){let t=JSON.stringify(this.state),n=new Blob([t],{type:"application/json"}),r=URL.createObjectURL(n),a=document.createElement("a");a.href=r,a.download="suno_colony.json",a.click(),URL.revokeObjectURL(r)}else await this.storage.save(this.state)}async build(){try{this.state.allPagesProcessed||await this.fetchClips(),this.state.allLinksBuilt||await this.buildLinks()}finally{await this.saveState()}}async fetchClips(){for(console.log("Fetching liked clips...");;){await X(1e3);let{clips:e}=await ne.getClips(this.state.lastProcessedPage+1);if(!e.length){this.state.allPagesProcessed=!0;break}this.state.rawClips.push(...e),this.state.lastProcessedPage++,console.log(`Processed page ${this.state.lastProcessedPage}; total clips: ${this.state.rawClips.length}`)}}rawClipsById={};async loadClip(e){await X(1e3);console.log(`Clip ${e} not found in cache, loading...`);let t=await ne.getClip(e)??Qe(e);return this.state.rawClips.push(t),t}getClipByIdSync(e){return this.rawClipsById[e]??=this.state.rawClips.find(t=>Je(e)?t.audio_url.includes(e):t.id===e)}async getClipById(e){return e.startsWith("m_")&&(e=e.slice(2)),this.getClipByIdSync(e)??await this.loadClip(e)}async buildLinks(){console.log("Building links...");for(let e=0;e<this.state.rawClips.length;e++){let t=this.state.rawClips[e];e%100===0&&console.log(`Processed ${e} clips out of ${this.state.rawClips.length}`);let{metadata:n}=t,[r,a]="history"in n?K(n.history[0],i=>typeof i=="string"?[i,"extend"]:i.infill?[i.id,"inpaint"]:[i.id,"extend"]):"concat_history"in n?[n.concat_history[1].id,"apply"]:"cover_clip_id"in n?[n.cover_clip_id,"cover"]:"upsample_clip_id"in n?[n.upsample_clip_id,"remaster"]:"type"in n&&n.type==="edit_crop"?await Te(t,this.state.rawClips).then(i=>i?[i,"crop"]:[void 0,void 0]):[void 0,void 0];r&&this.state.links.push([(await this.getClipById(r)).id,t.id,a])}this.state.allLinksBuilt=!0,console.log(`Built ${this.state.links.length} links.`),console.log("Colony built. Run `await vovas.colony.render()` to view it!")}_linkedClips;get linkedClips(){return this._linkedClips??=this.getLinkedClips()}getLinkedClips(){let e=this.state.links.reduce((n,[r,a,i])=>{let s=I(n,{id:r})??k(`Could not find parent for link ${r} -> ${a}.`),c=I(n,{id:a})??k(`Could not find child for link ${r} -> ${a}.`);if(c.parent)throw new Error(`Child ${a} already has a parent: ${c.parent.clip.id}`);return c.parent={kind:i,clip:s},(s.children??=[]).push({kind:i,clip:c}),n},U(this.state.rawClips));for(let n of e.filter(({parent:r})=>!r))t(n,n);return e;function t(n,r){Object.assign(n,{root:r});for(let{clip:a}of n.children??[])t(a,r)}}_rootClips;get rootClips(){return this._rootClips??=this.getRootClips()}getRootClips(){let e=this.linkedClips.filter(({parent:t})=>!t);return C(e)}get sortedClips(){let e=[],{rootClips:t}=this;for(let r of t)n(r);return e.reverse();function n(r){e.push(r);let{children:a}=r;if(a)for(let{clip:i}of C(a,({clip:s})=>s.created_at))n(i)}}get syntheticLinks(){let e=[],{rootClips:t}=this,n=t[0];for(let r of this.linkedClips.filter(({children:a})=>a?.length))e.push([(r.root??k(`Clip ${r.id} has no root.`)).id,r.id,"descendant"]);return e}getTotalDescendants(e){let t=I(this.linkedClips,{id:e})??k(`Clip ${e} not found.`);return t.totalDescendants??=1+(t.children?.reduce((n,{clip:{id:r}})=>n+this.getTotalDescendants(r),0)??0)}_graphData=void 0;getGraphData(){let e=this.sortedClips.map(({id:r,title:a,metadata:{tags:i},created_at:s,children:c,audio_url:y,image_url:f,root:x})=>({id:r,name:a||i||s||r,created_at:s,audio_url:y,image_url:f,tags:i,rootId:x?.id,val:r===x?.id&&c?.length?2:c?.length?1:.5})),t=([r,a,i])=>({source:r,target:a,kind:i,color:i==="next"?"#006":void 0,isMain:!Ye.includes(i)&&this.getTotalDescendants(a)>1});return{nodes:e,links:[...this.syntheticLinks,...this.state.links].map(t)}}get graphData(){return this._graphData??=this.getGraphData()}getHtml(e){return console.log("Rendering your colony, give it a few seconds..."),`<script>(vovas = {${window.vovas.main.toString()}}).main();vovas.colony.render(...${JSON.stringify([e,this.graphData])})<\/script>`}async render(e,t){console.log("Rendering your colony, give it a few seconds..."),this._graphData??=t,await oe(this,this.graphData,{mode:e})}renderToFile(...e){let t=this.getHtml(...e),n=new Blob([t],{type:"text/html"}),r=URL.createObjectURL(n),a=document.createElement("a");a.href=r,a.download="suno_colony.html",a.click(),URL.revokeObjectURL(r)}},G=new H;G.stateLoaded.promise.then(async()=>{console.log("Welcome to Vova\u2019s Suno Colony! This is a nifty tool to visualize your liked clips and the relationships between them, such as extensions, inpaints, covers, etc., in a graph format. It takes a bit of time and hacks to build, but hopefully it\u2019ll be worth it!");let{state:{allPagesProcessed:o,allLinksBuilt:e}}=G;!o||!e?console.log("Run `await vovas.colony.build()` to start or continue building your colony!"):(console.log("Your colony is built, rendering!"),await G.render())});function Je(o){return o.match(/_\d+$/)}function Qe(o){return console.warn(`Clip ${o} not found, creating a missing clip.`),{isMissing:!0,id:o,title:"*Clip not found*",created_at:null,audio_url:`https://cdn1.suno.ai/${o}.mp3`,image_url:"",metadata:{duration:0,tags:""}}}ue(window.vovas,{Colony:H,colony:G,debug:fe});})();
}}).main();
